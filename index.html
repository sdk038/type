<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TypeRacer Elite Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #fdbb2d;
            --secondary: #22c1c3;
            --success: #4ade80;
            --error: #f87171;
            --dark-card: rgba(20, 20, 35, 0.8);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: radial-gradient(circle at top, #1e1e3f, #0f0c29);
            min-height: 100vh;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
        }

        .container { max-width: 800px; width: 100%; }

        /* –ö—Ä–∞—Å–∏–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .game-card {
            background: var(--dark-card);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }

        /* –¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏ */
        .text-display {
            font-size: 1.6rem;
            line-height: 1.6;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            word-break: break-word;
            margin-bottom: 25px;
            color: #646669; /* –¶–≤–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∫–∞–∫ –≤ MonkeyType */
        }

        .correct { color: #d1d0c5; } /* –°–≤–µ—Ç–ª—ã–π –¥–ª—è –Ω–∞–ø–µ—á–∞—Ç–∞–Ω–Ω–æ–≥–æ */
        .current-char {
            color: var(--primary);
            border-left: 3px solid var(--primary);
            margin-left: -3px;
            animation: blink 0.8s infinite;
        }
        .wrong { background: rgba(248, 113, 113, 0.4); color: #fff; border-radius: 4px; }

        @keyframes blink { 50% { border-color: transparent; } }

        /* –¢—Ä–∞—Å—Å–∞ –∏ –º–∞—à–∏–Ω–∫–∏ */
        .race-track {
            height: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            position: relative;
            margin: 40px 0 20px;
        }

        .race-car {
            position: absolute;
            transition: left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-size: 32px;
            top: -40px;
            margin-left: -16px;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –æ–≥–Ω—è –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ */
        .fast-fire {
            filter: drop-shadow(0 0 15px #ff4e50) drop-shadow(0 0 5px #fdbb2d);
            animation: fire-shake 0.1s infinite;
        }

        @keyframes fire-shake {
            0% { transform: translate(0,0); }
            50% { transform: translate(1px, 1px); }
            100% { transform: translate(0,0); }
        }

        /* –ö–Ω–æ–ø–∫–∏ –∏ –∏–Ω–ø—É—Ç—ã */
        input {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: 2px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
            color: #fff;
            font-size: 18px;
            outline: none;
            transition: 0.3s;
        }

        input:focus { border-color: var(--primary); background: rgba(0,0,0,0.4); }

        .btn {
            padding: 16px 24px;
            border-radius: 16px;
            border: none;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-primary { background: linear-gradient(45deg, var(--primary), #ff9a00); color: #000; }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(253, 187, 45, 0.4); }

        .btn-exit { background: rgba(255, 78, 80, 0.2); color: #ff4e50; border: 1px solid rgba(255, 78, 80, 0.3); }
        .btn-exit:hover { background: rgba(255, 78, 80, 0.4); }

        .stat-badge {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 20px;
            text-align: center;
        }

        .stat-label { font-size: 11px; text-transform: uppercase; color: #888; margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: 900; color: var(--primary); }

        #countdown {
            font-size: 80px;
            font-weight: 900;
            text-align: center;
            background: linear-gradient(to bottom, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            height: 100px;
        }

        input#typingInput { position: absolute; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="lobby" class="game-card" style="text-align: center;">
        <h1 style="margin-bottom: 25px; font-size: 2.5rem;">üèéÔ∏è SPEED <span style="color:var(--primary)">TYPER</span></h1>
        <input type="text" id="playerName" placeholder="–¢–≤–æ—ë –∏–º—è –≥–æ–Ω—â–∏–∫–∞" style="margin-bottom: 15px;">
        <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–¥–ª—è –≤—Ö–æ–¥–∞)" style="margin-bottom: 25px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <button class="btn btn-primary" onclick="createRoom()">–°–û–ó–î–ê–¢–¨</button>
            <button class="btn" style="background: #444;" onclick="joinRoom()">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="gameView" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="roomInfo" style="font-weight: 400; opacity: 0.7;"></h2>
            <button class="btn btn-exit" style="padding: 8px 16px;" onclick="exitRoom()">–ü–û–ö–ò–ù–£–¢–¨</button>
        </div>

        <button id="startBtn" class="btn btn-primary" style="width: 100%; display: none; margin-bottom: 20px;" onclick="requestStart()">–ó–ê–ü–£–°–¢–ò–¢–¨ –ú–û–¢–û–†–´ üöÄ</button>

        <div id="countdown"></div>

        <div class="game-card">
            <div id="textDisplay" class="text-display">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

            <div id="inputMirror" class="btn" style="background: #fff; color: #000; width: 100%; text-align: center; font-size: 1.2rem;" onclick="focusInput()">
                –ù–ê–ñ–ú–ò –ò –ü–ï–ß–ê–¢–ê–ô
            </div>
            <input type="text" id="typingInput" autocomplete="off">

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 30px;">
                <div class="stat-badge"><div class="stat-label">WPM</div><div id="wpm" class="stat-value">0</div></div>
                <div class="stat-badge"><div class="stat-label">Accuracy</div><div id="acc" class="stat-value">100%</div></div>
                <div class="stat-badge"><div class="stat-label">Progress</div><div id="progress" class="stat-value">0%</div></div>
            </div>
        </div>

        <div id="playersList"></div>
    </div>
</div>

<script>
    // –¢–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
    const firebaseConfig = {
        apiKey: "AIzaSyCX5cv94WSVGJfX9Vddgxrqgg9CEH_QgvA",
        authDomain: "prince-10014.firebaseapp.com",
        databaseURL: "https://prince-10014-default-rtdb.firebaseio.com",
        projectId: "prince-10014",
        storageBucket: "prince-10014.firebasestorage.app",
        messagingSenderId: "900737897462",
        appId: "1:900737897462:web:a29a4d2c8cada3a3f36dd7",
        measurementId: "G-EP6VX4V6ET"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –±–∞–∑–∞ —Å–ª–æ–≤
    const phrases = [
        "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ, —á—Ç–æ –≤—ã –∑–Ω–∞–µ—Ç–µ, –∞ —Ç–æ, —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã—è—Å–Ω–∏—Ç—å.",
        "–£—Å–ø–µ—Ö ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏–¥—Ç–∏ –æ—Ç –æ–¥–Ω–æ–π –Ω–µ—É–¥–∞—á–∏ –∫ –¥—Ä—É–≥–æ–π, –Ω–µ —Ç–µ—Ä—è—è —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞.",
        "–í–∞—à–µ –≤—Ä–µ–º—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ, –ø–æ—ç—Ç–æ–º—É –Ω–µ —Ç—Ä–∞—Ç—å—Ç–µ –µ–≥–æ –Ω–∞ –∂–∏–∑–Ω—å —á—É–∂–æ–π –∂–∏–∑–Ω—å—é.",
        "–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –±—É–¥—É—â–µ–µ ‚Äî —ç—Ç–æ —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ —Å–∞–º–æ–º—É.",
        "–°–ª–æ–∂–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –≤–∞—à –≤—Ä–∞–≥. –õ—é–±–æ–π –¥—É—Ä–∞–∫ –º–æ–∂–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å —Å–ª–æ–∂–Ω—ã–π –∫–æ–¥.",
        "–í—Å–µ–≥–¥–∞ –ø–∏—à–∏—Ç–µ –∫–æ–¥ —Ç–∞–∫, –±—É–¥—Ç–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å –µ–≥–æ –±—É–¥–µ—Ç —Å–∫–ª–æ–Ω–Ω—ã–π –∫ –Ω–∞—Å–∏–ª–∏—é –ø—Å–∏—Ö–æ–ø–∞—Ç.",
        "–°–Ω–∞—á–∞–ª–∞ —Ä–µ—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É. –ó–∞—Ç–µ–º –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–¥.",
        "–û—à–∏–±–∫–∏ ‚Äî —ç—Ç–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å.",
        "–í–µ–ª–∏–∫–∏–µ –¥–µ–ª–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –º–∞–ª–µ–Ω—å–∫–∏—Ö —à–∞–≥–æ–≤ –∏ —á–∞—à–∫–∏ –≥–æ—Ä—è—á–µ–≥–æ –∫–æ—Ñ–µ.",
        "–ñ–∏–∑–Ω—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞, —á—Ç–æ–±—ã —Ç—Ä–∞—Ç–∏—Ç—å –µ—ë –Ω–∞ –ø–ª–æ—Ö–æ–π –∫–æ–¥ –∏ –º–µ–¥–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.",
        "–í –º–∏—Ä–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç 10 —Ç–∏–ø–æ–≤ –ª—é–¥–µ–π: —Ç–µ, –∫—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç –¥–≤–æ–∏—á–Ω—ã–π –∫–æ–¥, –∏ —Ç–µ, –∫—Ç–æ –Ω–µ—Ç.",
        "–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ ‚Äî —ç—Ç–æ –º–æ—Å—Ç –º–µ–∂–¥—É –≤–∞—à–µ–π –º—ã—Å–ª—å—é –∏ –µ—ë —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –Ω–∞ —ç–∫—Ä–∞–Ω–µ.",
        "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –¥–µ–ª–∞—Ç—å —Ç–æ, —á–µ–≥–æ –æ—á–µ–Ω—å –Ω–µ —Ö–æ—á–µ—Ç—Å—è, —á—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å —Ç–æ–≥–æ, —á–µ–≥–æ –æ—á–µ–Ω—å —Ö–æ—á–µ—Ç—Å—è.",
        "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—É—Ç–∞–π—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ —Ü–µ–ª–∏.",
        "–ö–æ–¥ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ª–∂–µ—Ç, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ –Ω–µ–º—É.",
        "–ë—É–¥—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–æ–π, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –≤–∏–¥–µ—Ç—å –≤ —ç—Ç–æ–º –º–∏—Ä–µ."
    ];

    let state = {
        roomID: null, playerName: '', text: '',
        pos: 0, errors: 0, totalTyped: 0,
        startTime: null, isRacing: false, isHost: false, restarting: false
    };

    window.onload = async () => {
        const r = localStorage.getItem('tr_roomID');
        const n = localStorage.getItem('tr_playerName');
        if (r && n) {
            state.roomID = r; state.playerName = n;
            state.isHost = localStorage.getItem('tr_isHost') === 'true';
            initView(); listenToRoom(r);
        }
    };

    function initView() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameView').style.display = 'block';
        document.getElementById('roomInfo').innerText = "–ö–û–î –ì–ò–õ–¨–î–ò–ò: " + state.roomID;
        if(state.isHost) document.getElementById('startBtn').style.display = 'block';
    }

    function focusInput() { if(state.isRacing) document.getElementById('typingInput').focus(); }

    async function createRoom() {
        const n = document.getElementById('playerName').value.trim();
        if(!n) return alert("–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è, –≥–æ–Ω—â–∏–∫!");
        const r = Math.random().toString(36).substring(2, 6).toUpperCase();
        state = {...state, roomID: r, playerName: n, isHost: true, text: phrases[Math.floor(Math.random()*phrases.length)]};
        saveSession(r, n, true);
        await db.ref('rooms/' + r).set({
            text: state.text, status: 'waiting', players: { [n]: { pos: 0, wpm: 0, finished: false } }
        });
        initView(); listenToRoom(r);
    }

    async function joinRoom() {
        const r = document.getElementById('roomCode').value.trim().toUpperCase();
        const n = document.getElementById('playerName').value.trim();
        if(!r || !n) return alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ!");
        const snap = await db.ref(`rooms/${r}`).once('value');
        if(!snap.exists()) return alert("–ì–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
        state = {...state, roomID: r, playerName: n, isHost: false};
        saveSession(r, n, false);
        await db.ref(`rooms/${r}/players/${n}`).update({ pos: 0, wpm: 0, finished: false });
        initView(); listenToRoom(r);
    }

    function saveSession(r, n, h) {
        localStorage.setItem('tr_roomID', r);
        localStorage.setItem('tr_playerName', n);
        localStorage.setItem('tr_isHost', h);
    }

    function exitRoom() { localStorage.clear(); location.reload(); }

    function listenToRoom(r) {
        db.ref('rooms/' + r).on('value', snap => {
            const d = snap.val(); if(!d) return;
            state.text = d.text;
            updatePlayers(d.players);
            if(d.status === 'starting' && !state.counting) startCountdown();
            if(d.status === 'racing' && !state.isRacing) startRace();
            if(Object.values(d.players).some(p => p.finished) && !state.restarting) autoRestart();
        });
    }

    function requestStart() { db.ref(`rooms/${state.roomID}/status`).set('starting'); }

    function startCountdown() {
        state.counting = true;
        document.getElementById('startBtn').style.display = 'none';
        let c = 3;
        const t = setInterval(() => {
            document.getElementById('countdown').innerText = c > 0 ? c : 'üèÅ';
            c--;
            if(c < -1) {
                clearInterval(t); document.getElementById('countdown').innerText = '';
                if(state.isHost) db.ref(`rooms/${state.roomID}/status`).set('racing');
                state.counting = false;
            }
        }, 1000);
    }

    function startRace() {
        state.isRacing = true; state.startTime = Date.now();
        state.pos = 0; state.errors = 0; state.totalTyped = 0;
        document.getElementById('typingInput').focus();
        document.getElementById('inputMirror').style.display = 'none';
    }

    function updatePlayers(players) {
        const list = document.getElementById('playersList');
        list.innerHTML = '';
        for(let n in players) {
            const p = players[n];
            const perc = (p.pos / state.text.length) * 100;
            const isFast = p.wpm > 80;
            list.innerHTML += `
                <div class="game-card" style="padding:15px; margin-bottom:10px; background:rgba(255,255,255,0.03)">
                    <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:10px">
                        <span>${n === state.playerName ? '<b>–í–´</b>' : n}</span>
                        <span style="color:var(--primary)">${p.wpm} WPM</span>
                    </div>
                    <div class="race-track">
                        <div class="race-car ${isFast ? 'fast-fire' : ''}" style="left:${perc}%">üèéÔ∏è</div>
                    </div>
                </div>`;
        }
        renderText();
    }

    function renderText() {
        const d = document.getElementById('textDisplay');
        let h = "";
        for(let i=0; i<state.text.length; i++) {
            let c = i < state.pos ? "correct" : (i === state.pos ? "current-char" : "");
            h += `<span class="${c}">${state.text[i] === ' ' ? '&nbsp;' : state.text[i]}</span>`;
        }
        d.innerHTML = h;
    }

    function autoRestart() {
        state.restarting = true; state.isRacing = false;
        let tl = 5;
        const t = setInterval(() => {
            document.getElementById('countdown').style.fontSize = '30px';
            document.getElementById('countdown').innerText = `–°–õ–ï–î–£–Æ–©–ò–ô –ó–ê–ï–ó–î –ß–ï–†–ï–ó ${tl}...`;
            tl--;
            if(tl < 0) {
                clearInterval(t);
                document.getElementById('countdown').style.fontSize = '80px';
                if(state.isHost) {
                    const nt = phrases[Math.floor(Math.random()*phrases.length)];
                    db.ref(`rooms/${state.roomID}`).update({ text: nt, status: 'starting' });
                    db.ref(`rooms/${state.roomID}/players`).once('value', s => {
                        const p = s.val();
                        for(let k in p) db.ref(`rooms/${state.roomID}/players/${k}`).update({pos:0, wpm:0, finished:false});
                    });
                }
                state.restarting = false;
                document.getElementById('inputMirror').style.display = 'block';
            }
        }, 1000);
    }

    document.getElementById('typingInput').addEventListener('input', e => {
        if(!state.isRacing) return;
        const v = e.target.value;
        const char = v[v.length-1];
        if(!char) return;
        state.totalTyped++;
        if(char === state.text[state.pos]) {
            state.pos++; e.target.value = "";
            const wpm = Math.round((state.pos/5)/((Date.now()-state.startTime)/60000)) || 0;
            const acc = Math.round(((state.totalTyped-state.errors)/state.totalTyped)*100);
            document.getElementById('wpm').innerText = wpm;
            document.getElementById('acc').innerText = acc + '%';
            document.getElementById('progress').innerText = Math.round((state.pos/state.text.length)*100) + '%';
            const fin = state.pos === state.text.length;
            db.ref(`rooms/${state.roomID}/players/${state.playerName}`).update({pos:state.pos, wpm:wpm, finished:fin});
            if(fin) state.isRacing = false;
        } else {
            state.errors++; e.target.value = "";
            const cur = document.querySelector('.current-char');
            if(cur) { cur.classList.add('wrong'); setTimeout(()=>cur.classList.remove('wrong'),100); }
        }
        renderText();
    });
</script>
</body>
</html>