<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeRacer Online</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-info {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: #333;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .room-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .room-section input {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
        }

        .room-section button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .room-section button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }

        .players-list {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: #333;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .player-race {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            position: relative;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #667eea;
        }

        .race-track {
            height: 40px;
            background: #e9ecef;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        .race-car {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            transition: left 0.3s ease;
        }

        .text-display {
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 24px;
            line-height: 1.8;
            color: #333;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            text-align: center;
        }

        .text-display span {
            padding: 2px 0;
        }

        .correct {
            color: #28a745;
            background: rgba(40,167,69,0.1);
        }

        .incorrect {
            color: #dc3545;
            background: rgba(220,53,69,0.2);
        }

        .current {
            border-bottom: 3px solid #667eea;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .input-area {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .input-area input {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            border: 3px solid #667eea;
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
        }

        .input-area input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 20px rgba(102,126,234,0.3);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: #333;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .countdown {
            font-size: 48px;
            text-align: center;
            margin: 30px 0;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .winner-message {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            margin: 20px 0;
            animation: celebrate 0.5s ease;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .status.waiting {
            background: rgba(255,193,7,0.2);
            color: #856404;
        }

        .status.racing {
            background: rgba(40,167,69,0.2);
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÅ TypeRacer Online</h1>

        <div class="game-info">
            <div class="room-section">
                <input type="text" id="roomCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">
                <input type="text" id="playerName" placeholder="–í–∞—à–µ –∏–º—è">
                <button onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            </div>
            <div id="roomInfo" style="margin-top: 10px; font-weight: bold;"></div>
            <div id="gameStatus" class="status" style="display: none;"></div>
        </div>

        <div class="players-list" id="playersList"></div>

        <div id="countdown" class="countdown" style="display: none;"></div>

        <div class="text-display" id="textDisplay">
            –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!
        </div>

        <div class="input-area">
            <input type="text" id="typingInput" placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å..." disabled>
        </div>

        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">–°–∫–æ—Ä–æ—Å—Ç—å (WPM)</div>
                <div class="stat-value" id="wpm">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                <div class="stat-value" id="accuracy">100%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
                <div class="stat-value" id="progress">0%</div>
            </div>
        </div>
    </div>

    <script>
        const texts = [
            "–ë—ã—Å—Ç—Ä–∞—è –∫–æ—Ä–∏—á–Ω–µ–≤–∞—è –ª–∏—Å–∞ –ø–µ—Ä–µ–ø—Ä—ã–≥–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ –ª–µ–Ω–∏–≤—É—é —Å–æ–±–∞–∫—É. –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ—Ñ–µ –≤ –∫–æ–¥.",
            "–ñ–∏–∑–Ω—å –ø–æ–¥–æ–±–Ω–∞ –µ–∑–¥–µ –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ. –ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–≤–Ω–æ–≤–µ—Å–∏–µ, –≤—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä–µ–¥ –∫ —Å–≤–æ–∏–º —Ü–µ–ª—è–º.",
            "–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–¥–µ–ª–∞—Ç—å –≤–µ–ª–∏–∫—É—é —Ä–∞–±–æ—Ç—É - —ç—Ç–æ –ª—é–±–∏—Ç—å —Ç–æ, —á—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ. –£—Å–ø–µ—Ö –Ω–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª–µ–Ω, –Ω–µ—É–¥–∞—á–∞ –Ω–µ —Ñ–∞—Ç–∞–ª—å–Ω–∞.",
            "–ò–Ω–Ω–æ–≤–∞—Ü–∏–∏ –æ—Ç–ª–∏—á–∞—é—Ç –ª–∏–¥–µ—Ä–∞ –æ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è. –ë—É–¥—É—â–µ–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–º, –∫—Ç–æ –≤–µ—Ä–∏—Ç –≤ –∫—Ä–∞—Å–æ—Ç—É —Å–≤–æ–∏—Ö –º–µ—á—Ç–∞–Ω–∏–π –∏ –∏–¥–µ–π."
        ];

        let gameState = {
            roomCode: '',
            playerName: '',
            players: {},
            currentText: '',
            currentIndex: 0,
            startTime: null,
            errors: 0,
            totalChars: 0,
            isGameActive: false,
            countdownActive: false
        };

        const input = document.getElementById('typingInput');
        const display = document.getElementById('textDisplay');

        async function createRoom() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è!');
                return;
            }

            const room = 'ROOM' + Math.random().toString(36).substr(2, 6).toUpperCase();
            gameState.roomCode = room;
            gameState.playerName = name;
            gameState.currentText = texts[Math.floor(Math.random() * texts.length)];

            await saveGameState();

            document.getElementById('roomInfo').textContent = `–ö–æ–º–Ω–∞—Ç–∞: ${room} | –ò–≥—Ä–æ–∫: ${name}`;
            document.getElementById('roomCode').value = room;

            updateDisplay();
            pollGameState();
            showStatus('–û–∂–∏–¥–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤...', 'waiting');
        }

        async function joinRoom() {
            const room = document.getElementById('roomCode').value.trim().toUpperCase();
            const name = document.getElementById('playerName').value.trim();

            if (!room || !name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã –∏ –≤–∞—à–µ –∏–º—è!');
                return;
            }

            try {
                const existingState = await window.storage.get(`game:${room}`, true);
                if (!existingState) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                    return;
                }

                gameState.roomCode = room;
                gameState.playerName = name;

                const state = JSON.parse(existingState.value);
                gameState.currentText = state.text;
                gameState.players = state.players || {};

                await saveGameState();

                document.getElementById('roomInfo').textContent = `–ö–æ–º–Ω–∞—Ç–∞: ${room} | –ò–≥—Ä–æ–∫: ${name}`;
                updateDisplay();
                pollGameState();
                showStatus('–û–∂–∏–¥–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤...', 'waiting');
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ!');
            }
        }

        async function saveGameState() {
            if (!gameState.roomCode) return;

            try {
                const existingState = await window.storage.get(`game:${gameState.roomCode}`, true);
                let state = existingState ? JSON.parse(existingState.value) : { players: {}, text: gameState.currentText };

                state.players = state.players || {};
                state.players[gameState.playerName] = {
                    progress: gameState.currentIndex,
                    total: gameState.currentText.length,
                    finished: gameState.currentIndex >= gameState.currentText.length,
                    wpm: calculateWPM(),
                    timestamp: Date.now()
                };
                state.text = gameState.currentText;

                await window.storage.set(`game:${gameState.roomCode}`, JSON.stringify(state), true);
                updatePlayersList(state.players);
            } catch (error) {
                console.error('Error saving state:', error);
            }
        }

        async function pollGameState() {
            if (!gameState.roomCode) return;

            try {
                const existingState = await window.storage.get(`game:${gameState.roomCode}`, true);
                if (existingState) {
                    const state = JSON.parse(existingState.value);
                    gameState.players = state.players || {};
                    updatePlayersList(state.players);

                    if (!gameState.isGameActive && !gameState.countdownActive && Object.keys(gameState.players).length >= 2) {
                        const allPlayersActive = Object.values(gameState.players).some(p =>
                            Date.now() - p.timestamp < 30000 && p.progress > 0
                        );
                        if (allPlayersActive && !gameState.isGameActive) {
                            startCountdown();
                        }
                    }
                }
            } catch (error) {
                console.error('Error polling state:', error);
            }

            setTimeout(pollGameState, 1000);
        }

        function showStatus(text, type) {
            const status = document.getElementById('gameStatus');
            status.textContent = text;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function startCountdown() {
            if (gameState.countdownActive || gameState.isGameActive) return;

            gameState.countdownActive = true;
            showStatus('–ì–æ–Ω–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!', 'racing');

            const countdownEl = document.getElementById('countdown');
            countdownEl.style.display = 'block';

            let count = 3;
            countdownEl.textContent = count;

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.textContent = count;
                } else if (count === 0) {
                    countdownEl.textContent = '–í–ü–ï–†–Å–î!';
                } else {
                    clearInterval(interval);
                    countdownEl.style.display = 'none';
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            gameState.isGameActive = true;
            gameState.countdownActive = false;
            gameState.startTime = Date.now();
            input.disabled = false;
            input.focus();
        }

        function updateDisplay() {
            if (!gameState.currentText) return;

            let html = '';
            for (let i = 0; i < gameState.currentText.length; i++) {
                const char = gameState.currentText[i];
                let className = '';

                if (i < gameState.currentIndex) {
                    className = 'correct';
                } else if (i === gameState.currentIndex) {
                    className = 'current';
                }

                html += `<span class="${className}">${char === ' ' ? '&nbsp;' : char}</span>`;
            }

            display.innerHTML = html;
        }

        function updatePlayersList(players) {
            const list = document.getElementById('playersList');
            let html = '<h3 style="margin-bottom: 15px;">üèéÔ∏è –ì–æ–Ω—â–∏–∫–∏</h3>';

            for (const [name, data] of Object.entries(players)) {
                const percent = ((data.progress / data.total) * 100).toFixed(1);
                const isCurrentPlayer = name === gameState.playerName;

                html += `
                    <div class="player-race" style="${isCurrentPlayer ? 'border: 2px solid #667eea;' : ''}">
                        <div class="player-name">
                            ${name} ${isCurrentPlayer ? '(–í—ã)' : ''}
                            ${data.finished ? 'üèÜ' : ''}
                            - ${data.wpm} WPM
                        </div>
                        <div class="race-track">
                            <div class="race-car" style="left: ${percent}%">üèéÔ∏è</div>
                        </div>
                    </div>
                `;
            }

            list.innerHTML = html;

            const winner = Object.entries(players).find(([name, data]) => data.finished);
            if (winner && gameState.isGameActive) {
                showWinner(winner[0]);
            }
        }

        function showWinner(name) {
            if (!document.getElementById('winnerMsg')) {
                const msg = document.createElement('div');
                msg.id = 'winnerMsg';
                msg.className = 'winner-message';
                msg.textContent = `üèÜ ${name} –ø–æ–±–µ–¥–∏–ª! üèÜ`;
                document.querySelector('.container').insertBefore(msg, document.getElementById('playersList'));
            }
        }

        function calculateWPM() {
            if (!gameState.startTime) return 0;
            const timeInMinutes = (Date.now() - gameState.startTime) / 60000;
            const wordsTyped = gameState.currentIndex / 5;
            return Math.round(wordsTyped / timeInMinutes) || 0;
        }

        function updateStats() {
            document.getElementById('wpm').textContent = calculateWPM();

            const accuracy = gameState.totalChars > 0
                ? ((gameState.totalChars - gameState.errors) / gameState.totalChars * 100).toFixed(1)
                : 100;
            document.getElementById('accuracy').textContent = accuracy + '%';

            const progress = ((gameState.currentIndex / gameState.currentText.length) * 100).toFixed(1);
            document.getElementById('progress').textContent = progress + '%';
        }

        input.addEventListener('input', async (e) => {
            if (!gameState.isGameActive) {
                if (e.target.value.length > 0 && Object.keys(gameState.players).length >= 2) {
                    startCountdown();
                }
                return;
            }

            const typed = e.target.value;
            const expected = gameState.currentText.slice(0, typed.length);

            gameState.totalChars++;

            if (typed === expected) {
                gameState.currentIndex = typed.length;
                updateDisplay();
                updateStats();

                if (gameState.currentIndex >= gameState.currentText.length) {
                    gameState.isGameActive = false;
                    input.disabled = true;
                    showStatus('–í—ã —Ñ–∏–Ω–∏—à–∏—Ä–æ–≤–∞–ª–∏! üéâ', 'racing');
                }

                await saveGameState();
            } else {
                gameState.errors++;
                e.target.value = expected;
            }
        });

        input.addEventListener('paste', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>