<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TypeRacer Elite Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #fdbb2d;
            --bg: #0f0c29;
            --card-bg: rgba(25, 25, 50, 0.9);
            --border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow-x: hidden;
        }

        .container { width: 100%; max-width: 800px; margin: 0 auto; flex: 1; padding-bottom: 60px; }

        .game-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .text-display {
            font-size: 1.4rem;
            line-height: 1.6;
            font-family: 'Consolas', monospace;
            color: #666;
            margin-bottom: 25px;
            text-align: left;
            word-wrap: break-word;
        }

        .correct { color: #fff; }
        .current { background: rgba(253, 187, 45, 0.3); border-radius: 4px; color: var(--primary); }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        #typingInput {
            width: 100%;
            padding: 18px;
            background: #000;
            border: 2px solid var(--border);
            border-radius: 12px;
            color: #fff;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        #typingInput:focus { border-color: var(--primary); }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { padding: 12px 25px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: #000; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-exit { background: #ff4e50; color: #fff; font-size: 12px; text-transform: uppercase; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stat-item { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; text-align: center; }
        .stat-val { display: block; font-weight: 900; color: var(--primary); font-size: 1.3rem; }
        .stat-label { font-size: 9px; color: #888; text-transform: uppercase; }

        /* –ú–∞—à–∏–Ω–∫–∏ */
        .track { height: 2px; background: var(--border); position: relative; margin: 35px 0 15px; }
        .car { position: absolute; top: -28px; font-size: 24px; transition: 0.5s linear; }

        /* –õ–æ–≥–æ—Ç–∏–ø –≤–Ω–∏–∑—É */
        .footer-logo {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 900;
            letter-spacing: 6px;
            opacity: 0.4;
            font-size: 14px;
            pointer-events: none;
        }

        #countdown { font-size: 5rem; text-align: center; color: var(--primary); height: 85px; font-weight: 900; }
        #restartTimer { color: var(--primary); font-weight: bold; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="lobby" class="game-card" style="margin-top: 50px; text-align: center;">
        <h2 style="margin-bottom: 25px;">üèéÔ∏è SPEED TYPER</h2>
        <input type="text" id="playerName" placeholder="–¢–≤–æ—ë –∏–º—è" style="width:100%; padding:15px; border-radius:10px; border:none; margin-bottom:10px; background:#111; color:#fff;">
        <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" style="width:100%; padding:15px; border-radius:10px; border:none; margin-bottom:20px; background:#111; color:#fff;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn btn-primary" onclick="createRoom()" style="margin:0">–°–û–ó–î–ê–¢–¨</button>
            <button class="btn" onclick="joinRoom()" style="background:#333; color:#fff;">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="gameView" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <span id="roomInfo" style="color:var(--primary); font-weight: bold;"></span>
            <button class="btn btn-exit" onclick="exitRoom()">–ü–æ–∫–∏–Ω—É—Ç—å</button>
        </div>

        <div id="restartTimer"></div>
        <div id="countdown"></div>
        <button id="startBtn" class="btn btn-primary" style="display:none; margin-bottom:20px;" onclick="requestStart()">–ó–ê–ü–£–°–¢–ò–¢–¨ –ú–û–¢–û–†–´ üöÄ</button>

        <div class="game-card">
            <div id="textDisplay" class="text-display">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞—Å—Å—ã...</div>
            <input type="text" id="typingInput" placeholder="–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è..." autocomplete="off" autocorrect="off" spellcheck="false" disabled>

            <div class="stats-grid">
                <div class="stat-item"><span id="wpm" class="stat-val">0</span><span class="stat-label">WPM</span></div>
                <div class="stat-item"><span id="timer" class="stat-val">00:00</span><span class="stat-label">Time</span></div>
                <div class="stat-item"><span id="acc" class="stat-val">100%</span><span class="stat-label">Acc</span></div>
                <div class="stat-item"><span id="progress" class="stat-val">0%</span><span class="stat-label">Prog</span></div>
            </div>
        </div>

        <div id="playersList"></div>
    </div>
</div>

<div class="footer-logo">SPEED RACER</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCX5cv94WSVGJfX9Vddgxrqgg9CEH_QgvA",
        authDomain: "prince-10014.firebaseapp.com",
        databaseURL: "https://prince-10014-default-rtdb.firebaseio.com",
        projectId: "prince-10014",
        storageBucket: "prince-10014.firebasestorage.app",
        messagingSenderId: "900737897462",
        appId: "1:900737897462:web:a29a4d2c8cada3a3f36dd7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const phrases = [
        "–°–∫–æ—Ä–æ—Å—Ç—å ‚Äî —ç—Ç–æ —Å—Ç—Ä–∞—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –∂–∏–≤–µ—Ç –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –≥–æ–Ω—â–∏–∫–∞.",
        "–ü–æ–±–µ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –∏ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ–π –ø–µ—á–∞—Ç–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ.",
        "–¢–≤–æ–π –∫–æ–¥ —Å–µ–≥–æ–¥–Ω—è ‚Äî —ç—Ç–æ –Ω–∞–¥–µ–∂–Ω—ã–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç —Ç–≤–æ–µ–≥–æ —É—Å–ø–µ—Ö–∞ –∑–∞–≤—Ç—Ä–∞.",
        "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–¥–∞–≤–∞–π—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ–≤–µ—Ä—à–∏–ª –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫.",
        "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –º—ã—Å–ª–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å.",
        "–ë—É–¥—É—â–µ–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–º, –∫—Ç–æ –≤–µ—Ä–∏—Ç –≤ –∫—Ä–∞—Å–æ—Ç—É —Å–≤–æ–∏—Ö –±–µ–∑—É–º–Ω—ã—Ö –∏–¥–µ–π.",
        "–í–µ–ª–∏–∫–∏–µ –¥–µ–ª–∞ –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –º–∞–ª–µ–Ω—å–∫–∏—Ö –∏ —É–≤–µ—Ä–µ–Ω–Ω—ã—Ö —à–∞–≥–æ–≤.",
        "–ñ–∏–∑–Ω—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞, —á—Ç–æ–±—ã —Ç—Ä–∞—Ç–∏—Ç—å –µ–µ –Ω–∞ –ø–ª–æ—Ö–æ–π –∫–æ–¥ –∏ —Å–∫—É–∫—É."
    ];

    let state = {
        roomID: null, playerName: '', text: '',
        pos: 0, startTime: null, isRacing: false, isHost: false,
        timerInterval: null, restarting: false
    };

    function initView() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameView').style.display = 'block';
        document.getElementById('roomInfo').innerText = "–ö–û–î: " + state.roomID;
        if(state.isHost) document.getElementById('startBtn').style.display = 'block';
    }

    async function createRoom() {
        const n = document.getElementById('playerName').value.trim();
        if(!n) return alert("–ò–º—è!");
        const r = Math.random().toString(36).substring(2, 6).toUpperCase();
        state = {...state, roomID: r, playerName: n, isHost: true};
        await db.ref('rooms/' + r).set({
            text: phrases[Math.floor(Math.random()*phrases.length)],
            status: 'waiting', players: { [n]: { pos: 0, wpm: 0, finished: false } }
        });
        initView(); listen(r);
    }

    async function joinRoom() {
        const r = document.getElementById('roomCode').value.trim().toUpperCase();
        const n = document.getElementById('playerName').value.trim();
        if(!r || !n) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");
        const snap = await db.ref(`rooms/${r}`).once('value');
        if(!snap.exists()) return alert("–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
        state = {...state, roomID: r, playerName: n, isHost: false};
        await db.ref(`rooms/${r}/players/${n}`).update({ pos: 0, wpm: 0, finished: false });
        initView(); listen(r);
    }

    function exitRoom() { location.reload(); }

    function listen(r) {
        db.ref('rooms/' + r).on('value', snap => {
            const d = snap.val(); if(!d) return;
            state.text = d.text;
            renderPlayers(d.players);
            if(d.status === 'starting' && !state.counting) startCountdown();
            if(d.status === 'racing' && !state.isRacing) startRace();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–∫–æ–Ω—á–∞–Ω–∏–µ –≤—Å–µ–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏
            const pArray = Object.values(d.players);
            const everyoneFinished = pArray.every(p => p.finished);
            if(everyoneFinished && d.status === 'racing' && !state.restarting) {
                startAutoRestart();
            }
        });
    }

    function requestStart() { db.ref(`rooms/${state.roomID}/status`).set('starting'); }

    function startCountdown() {
        state.counting = true;
        document.getElementById('startBtn').style.display = 'none';
        let c = 3;
        const t = setInterval(() => {
            document.getElementById('countdown').innerText = c > 0 ? c : 'GO!';
            c--;
            if(c < -1) {
                clearInterval(t); document.getElementById('countdown').innerText = '';
                if(state.isHost) db.ref(`rooms/${state.roomID}/status`).set('racing');
                state.counting = false;
            }
        }, 1000);
    }

    function startRace() {
        state.isRacing = true; state.restarting = false; state.startTime = Date.now(); state.pos = 0;
        document.getElementById('restartTimer').innerText = "";
        const inp = document.getElementById('typingInput');
        inp.disabled = false; inp.value = ""; inp.focus();
        state.timerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - state.startTime) / 1000);
            document.getElementById('timer').innerText = `${Math.floor(diff/60).toString().padStart(2,'0')}:${(diff%60).toString().padStart(2,'0')}`;
        }, 1000);
    }

    function startAutoRestart() {
        state.restarting = true;
        let timeLeft = 5;
        const rT = setInterval(() => {
            document.getElementById('restartTimer').innerText = `–ù–æ–≤–∞—è –∏–≥—Ä–∞ —á–µ—Ä–µ–∑ ${timeLeft}...`;
            timeLeft--;
            if(timeLeft < 0) {
                clearInterval(rT);
                if(state.isHost) {
                    const newText = phrases[Math.floor(Math.random()*phrases.length)];
                    db.ref(`rooms/${state.roomID}`).update({
                        status: 'starting',
                        text: newText
                    });
                    // –°–±—Ä–æ—Å –∏–≥—Ä–æ–∫–æ–≤
                    db.ref(`rooms/${state.roomID}/players`).once('value', s => {
                        const players = s.val();
                        for(let p in players) {
                            db.ref(`rooms/${state.roomID}/players/${p}`).update({pos: 0, wpm: 0, finished: false});
                        }
                    });
                }
            }
        }, 1000);
    }

    function renderPlayers(players) {
        const list = document.getElementById('playersList');
        list.innerHTML = '';
        for(let n in players) {
            const p = players[n];
            const perc = (p.pos / state.text.length) * 100;
            list.innerHTML += `
                <div style="margin-bottom:15px">
                    <div style="display:flex; justify-content:space-between; font-size:11px; opacity:0.6">
                        <span>${n} ${n===state.playerName?'(–¢–´)':''}</span><span>${p.wpm} WPM</span>
                    </div>
                    <div class="track"><div class="car" style="left:${perc}%">üèéÔ∏è</div></div>
                </div>`;
        }
        updateDisplayText();
    }

    function updateDisplayText() {
        const d = document.getElementById('textDisplay');
        let h = "";
        for(let i=0; i<state.text.length; i++) {
            let cls = i < state.pos ? "correct" : (i === state.pos ? "current" : "");
            h += `<span class="${cls}">${state.text[i]}</span>`;
        }
        d.innerHTML = h;
    }

    document.getElementById('typingInput').addEventListener('input', e => {
        if(!state.isRacing) return;
        const val = e.target.value;
        const expected = state.text.substring(state.pos, state.pos + val.length);

        if(val === expected) {
            if(val.endsWith(" ") || state.pos + val.length === state.text.length) {
                state.pos += val.length;
                e.target.value = "";
                const wpm = Math.round((state.pos/5)/((Date.now()-state.startTime)/60000)) || 0;
                document.getElementById('wpm').innerText = wpm;
                document.getElementById('progress').innerText = Math.round((state.pos/state.text.length)*100) + '%';

                const isFin = state.pos === state.text.length;
                db.ref(`rooms/${state.roomID}/players/${state.playerName}`).update({pos:state.pos, wpm:wpm, finished: isFin});

                if(isFin) {
                    state.isRacing = false;
                    clearInterval(state.timerInterval);
                    e.target.disabled = true;
                }
            }
        }
        updateDisplayText();
    });
</script>
</body>
</html>