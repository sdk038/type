<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpeedRacer | Ultimate Type Experience</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #7000ff;
            --accent: #fdbb2d;
            --bg: #050510;
            --card-bg: rgba(20, 20, 35, 0.7);
            --border: rgba(255, 255, 255, 0.08);
            --text-muted: #808090;
            --error: #ff4e50;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: radial-gradient(circle at top right, #1a1a3a, #050510);
            color: #fff; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }
        .container { width: 100%; max-width: 900px; margin: 0 auto; flex: 1; padding: 40px 20px; }
        .game-card {
            background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid var(--border);
            border-radius: 24px; padding: 35px; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            position: relative; overflow: hidden;
        }
        .game-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        .text-display {
            font-size: 1.5rem; line-height: 1.7; font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted); margin-bottom: 30px; letter-spacing: -0.5px;
        }
        .correct { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .current {
            background: var(--primary); color: #000; border-radius: 4px;
            box-shadow: 0 0 15px var(--primary); animation: pulse 1.5s infinite;
        }
        .error-char { color: var(--error); text-decoration: underline; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        #typingInput {
            width: 100%; padding: 20px; background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border); border-radius: 16px; color: #fff;
            font-size: 1.25rem; margin-bottom: 25px; transition: all 0.3s;
        }
        #typingInput:focus { border-color: var(--primary); box-shadow: 0 0 20px rgba(0, 242, 255, 0.15); }
        #typingInput.error { border-color: var(--error); animation: shake 0.3s; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .stat-item { background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 16px; border: 1px solid var(--border); text-align: center; }
        .stat-val { display: block; font-weight: 800; color: var(--primary); font-size: 1.5rem; }
        .stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }
        .track { height: 4px; background: rgba(255,255,255,0.05); position: relative; margin: 40px 0 20px; border-radius: 2px; }
        .car { position: absolute; top: -35px; font-size: 28px; transition: all 0.5s; filter: drop-shadow(0 0 10px var(--primary)); }
        .btn { padding: 16px 32px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff; }
        .btn-exit { background: rgba(255, 78, 80, 0.1); color: #ff4e50; border: 1px solid rgba(255, 78, 80, 0.2); padding: 8px 16px; }
        #countdown { font-size: 6rem; text-align: center; color: var(--primary); font-weight: 900; height: 120px; }
        .lobby-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.3); color: #fff; margin-bottom: 15px; font-size: 16px; }
        .share-link {
            background: rgba(0, 242, 255, 0.1); padding: 12px 20px; border-radius: 100px;
            border: 1px solid var(--primary); cursor: pointer; display: inline-flex;
            align-items: center; gap: 10px; transition: all 0.3s;
        }
        .share-link:hover { background: rgba(0, 242, 255, 0.2); transform: scale(1.02); }
        .copy-notification {
            position: fixed; top: 20px; right: 20px; background: var(--primary);
            color: #000; padding: 15px 25px; border-radius: 12px; font-weight: 700;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div class="container">
    <div id="lobby" class="game-card" style="max-width: 450px; margin: 100px auto;">
        <h2 style="text-align: center; margin-bottom: 30px; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üèéÔ∏è NEON RACER</h2>
        <input type="text" id="playerName" class="lobby-input" placeholder="–¢–≤–æ—ë –∏–º—è" maxlength="20">
        <input type="text" id="roomCode" class="lobby-input" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º)" maxlength="6">

        <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
            <button class="btn btn-primary" onclick="createRoom()">üåê –°–û–ó–î–ê–¢–¨ –û–ù–õ–ê–ô–ù –ò–ì–†–£</button>
            <button class="btn" style="background: #333; color: #fff;" onclick="joinRoom()">üîó –í–û–ô–¢–ò –ü–û –ö–û–î–£</button>
            <button class="btn" style="background: transparent; border: 1px solid var(--primary); color: var(--primary);" onclick="startSolo()">‚ö° –û–î–ò–ù–û–ß–ù–ê–Ø –ü–†–ê–ö–¢–ò–ö–ê</button>
        </div>
    </div>

    <div id="gameView" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap: wrap; gap: 15px;">
            <div id="shareBox" class="share-link" onclick="copyLink()">
                <span id="roomInfo" style="color:var(--primary); font-weight: 800; font-size: 14px;"></span>
                <span style="color: var(--text-muted); font-size: 11px;">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£</span>
            </div>
            <button class="btn btn-exit" onclick="exitRoom()">‚Üê –ü–æ–∫–∏–Ω—É—Ç—å</button>
        </div>

        <div id="countdown"></div>
        <div id="restartTimer" style="text-align: center; color: var(--accent); margin-bottom: 15px; font-size: 18px; font-weight: 600;"></div>

        <button id="startBtn" class="btn btn-primary" style="display:none; width: 100%; margin-bottom: 30px;" onclick="requestStart()">–ó–ê–ü–£–°–¢–ò–¢–¨ –ì–û–ù–ö–£ ‚ö°Ô∏è</button>

        <div class="game-card">
            <div id="textDisplay" class="text-display">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞—Å—Å—ã...</div>
            <input type="text" id="typingInput" placeholder="–ñ–¥–∏ —Å—Ç–∞—Ä—Ç–∞..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled>

            <div class="stats-grid">
                <div class="stat-item"><span id="wpm" class="stat-val">0</span><span class="stat-label">WPM</span></div>
                <div class="stat-item"><span id="timer" class="stat-val">00:00</span><span class="stat-label">–í—Ä–µ–º—è</span></div>
                <div class="stat-item"><span id="acc" class="stat-val">100%</span><span class="stat-label">–¢–æ—á–Ω–æ—Å—Ç—å</span></div>
                <div class="stat-item"><span id="progress" class="stat-val">0%</span><span class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</span></div>
            </div>
        </div>
        <div id="playersList" style="margin-top: 20px;"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCX5cv94WSVGJfX9Vddgxrqgg9CEH_QgvA",
        authDomain: "prince-10014.firebaseapp.com",
        databaseURL: "https://prince-10014-default-rtdb.firebaseio.com",
        projectId: "prince-10014",
        storageBucket: "prince-10014.firebasestorage.app",
        messagingSenderId: "900737897462",
        appId: "1:900737897462:web:a29a4d2c8cada3a3f36dd7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const phrases = [
        "–ò–Ω–æ–≥–¥–∞ –ø–æ–ª–µ–∑–Ω–æ –≤–∑–≥–ª—è–Ω—É—Ç—å –Ω–∞ –ø—Ä–∏–≤—ã—á–Ω—ã–µ –≤–µ—â–∏ –ø–æ–¥ –¥—Ä—É–≥–∏–º —É–≥–ª–æ–º. –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ –º–æ–∂–µ—Ç –¥–∞—Ç—å —Å–≤–µ–∂–∏–µ –∏–¥–µ–∏.",
        "–ë—É–¥—É—â–µ–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–º, –∫—Ç–æ –≤–µ—Ä–∏—Ç –≤ –∫—Ä–∞—Å–æ—Ç—É —Å–≤–æ–∏—Ö –±–µ–∑—É–º–Ω—ã—Ö –∏–¥–µ–π –∏ –Ω–µ –±–æ–∏—Ç—Å—è –æ—à–∏–±–æ–∫.",
        "–ñ–∏–∑–Ω—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞, —á—Ç–æ–±—ã —Ç—Ä–∞—Ç–∏—Ç—å –µ–µ –Ω–∞ –ø–ª–æ—Ö–æ–π –∫–æ–¥ –∏ —Å–∫—É–∫—É. –î–µ–π—Å—Ç–≤—É–π —Å–º–µ–ª–æ!",
        "–í–µ–ª–∏–∫–∏–µ –¥–µ–ª–∞ –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –º–∞–ª–µ–Ω—å–∫–∏—Ö –∏ —É–≤–µ—Ä–µ–Ω–Ω—ã—Ö —à–∞–≥–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏.",
        "–ö–∞–∂–¥–∞—è –æ—à–∏–±–∫–∞ —ç—Ç–æ —à–∞–Ω—Å –Ω–∞—É—á–∏—Ç—å—Å—è —á–µ–º—É-—Ç–æ –Ω–æ–≤–æ–º—É –∏ —Å—Ç–∞—Ç—å –ª—É—á—à–µ —á–µ–º –≤—á–µ—Ä–∞.",
        "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–±—É–µ—Ç —Å–º–µ–ª–æ—Å—Ç–∏ –æ—Ç–ø—É—Å—Ç–∏—Ç—å —Å—Ç—Ä–∞—Ö –Ω–µ—É–¥–∞—á–∏ –∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å."
    ];

    let state = {
        roomID: null, playerName: '', text: '',
        pos: 0, startTime: null, isRacing: false, isHost: false,
        timerInterval: null, restarting: false, isSolo: false,
        errors: 0, totalChars: 0, lastInputLength: 0
    };

    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const rCode = urlParams.get('room');
        if (rCode) {
            document.getElementById('roomCode').value = rCode.toUpperCase();
        }
    };

    function showNotification(text) {
        const notif = document.createElement('div');
        notif.className = 'copy-notification';
        notif.textContent = text;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 2000);
    }

    function copyLink() {
        const link = window.location.origin + window.location.pathname + "?room=" + state.roomID;
        navigator.clipboard.writeText(link).then(() => {
            showNotification('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        });
    }

    function initView() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameView').style.display = 'block';
        document.getElementById('roomInfo').innerText = "–ö–û–î: " + state.roomID;
        if (state.isHost || state.isSolo) document.getElementById('startBtn').style.display = 'block';

        const newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + state.roomID;
        window.history.pushState({path:newurl},'',newurl);
    }

    async function createRoom() {
        const n = document.getElementById('playerName').value.trim() || "–ü–∏–ª–æ—Ç";
        const r = Math.random().toString(36).substring(2, 6).toUpperCase();
        state = {...state, roomID: r, playerName: n, isHost: true, isSolo: false};
        await db.ref('rooms/' + r).set({
            text: phrases[Math.floor(Math.random() * phrases.length)],
            status: 'waiting', players: {[n]: {pos: 0, wpm: 0, finished: false}}
        });
        initView();
        listen(r);
    }

    async function startSolo() {
        const n = document.getElementById('playerName').value.trim() || "–ò–≥—Ä–æ–∫";
        const r = "SOLO-" + Math.random().toString(36).substring(2, 5).toUpperCase();
        state = {...state, roomID: r, playerName: n, isHost: true, isSolo: true};
        state.text = phrases[Math.floor(Math.random() * phrases.length)];
        initView();
        document.getElementById('shareBox').style.display = 'none';
        renderPlayers({[n]: {pos: 0, wpm: 0, finished: false}});
    }

    async function joinRoom() {
        const r = document.getElementById('roomCode').value.trim().toUpperCase();
        const n = document.getElementById('playerName').value.trim() || "–ì–æ—Å—Ç—å";
        if (!r) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!");
        const snap = await db.ref(`rooms/${r}`).once('value');
        if (!snap.exists()) return alert("–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
        state = {...state, roomID: r, playerName: n, isHost: false, isSolo: false};
        await db.ref(`rooms/${r}/players/${n}`).update({pos: 0, wpm: 0, finished: false});
        initView();
        listen(r);
    }

    function exitRoom() {
        if (state.roomID && !state.isSolo) {
            db.ref(`rooms/${state.roomID}/players/${state.playerName}`).remove();
        }
        window.location.href = window.location.pathname;
    }

    function listen(r) {
        if (state.isSolo) return;
        db.ref('rooms/' + r).on('value', snap => {
            const d = snap.val();
            if (!d) return;
            state.text = d.text;
            renderPlayers(d.players);
            if (d.status === 'starting' && !state.counting) startCountdown();
            if (d.status === 'racing' && !state.isRacing) startRace();

            const pArray = Object.values(d.players);
            if (pArray.every(p => p.finished) && d.status === 'racing' && !state.restarting) {
                startAutoRestart();
            }
        });
    }

    function requestStart() {
        if (state.isSolo) startCountdown();
        else db.ref(`rooms/${state.roomID}/status`).set('starting');
    }

    function startCountdown() {
        state.counting = true;
        document.getElementById('startBtn').style.display = 'none';
        let c = 3;
        const t = setInterval(() => {
            document.getElementById('countdown').innerText = c > 0 ? c : '–ì–û!';
            c--;
            if (c < -1) {
                clearInterval(t);
                document.getElementById('countdown').innerText = '';
                if (state.isSolo) startRace();
                else if (state.isHost) db.ref(`rooms/${state.roomID}/status`).set('racing');
                state.counting = false;
            }
        }, 1000);
    }

    function startRace() {
        state.isRacing = true;
        state.restarting = false;
        state.startTime = Date.now();
        state.pos = 0;
        state.errors = 0;
        state.totalChars = 0;
        state.lastInputLength = 0;

        const inp = document.getElementById('typingInput');
        inp.disabled = false;
        inp.value = "";
        inp.classList.remove('error');
        inp.focus();

        state.timerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - state.startTime) / 1000);
            document.getElementById('timer').innerText = `${Math.floor(diff / 60).toString().padStart(2, '0')}:${(diff % 60).toString().padStart(2, '0')}`;
        }, 1000);
    }

    function startAutoRestart() {
        state.restarting = true;
        let timeLeft = 5;
        const rT = setInterval(() => {
            document.getElementById('restartTimer').innerText = `üîÑ –ù–æ–≤–∞—è –≥–æ–Ω–∫–∞ —á–µ—Ä–µ–∑ ${timeLeft}...`;
            timeLeft--;
            if (timeLeft < 0) {
                clearInterval(rT);
                document.getElementById('restartTimer').innerText = '';
                if (state.isSolo) {
                    state.text = phrases[Math.floor(Math.random() * phrases.length)];
                    renderPlayers({[state.playerName]: {pos: 0, wpm: 0, finished: false}});
                    startCountdown();
                } else if (state.isHost) {
                    db.ref(`rooms/${state.roomID}`).update({
                        status: 'starting',
                        text: phrases[Math.floor(Math.random() * phrases.length)]
                    });
                    db.ref(`rooms/${state.roomID}/players`).once('value', s => {
                        const players = s.val();
                        for (let p in players) db.ref(`rooms/${state.roomID}/players/${p}`).update({pos: 0, wpm: 0, finished: false});
                    });
                }
            }
        }, 1000);
    }

    function renderPlayers(players) {
        const list = document.getElementById('playersList');
        list.innerHTML = '';
        for (let n in players) {
            const p = players[n];
            const perc = state.text.length > 0 ? (p.pos / state.text.length) * 100 : 0;
            const statusEmoji = p.finished ? 'üèÅ' : 'üèéÔ∏è';
            list.innerHTML += `
                <div style="margin-bottom:15px">
                    <div style="display:flex; justify-content:space-between; font-size:12px; opacity:0.8; margin-bottom: 8px;">
                        <span style="font-weight: 600;">${n} ${n === state.playerName ? '(–¢–´)' : ''}</span>
                        <span style="color: var(--primary);">${p.wpm} WPM</span>
                    </div>
                    <div class="track"><div class="car" style="left:${perc}%">${statusEmoji}</div></div>
                </div>`;
        }
        updateDisplayText();
    }

    function updateDisplayText() {
        const d = document.getElementById('textDisplay');
        let h = "";
        for (let i = 0; i < state.text.length; i++) {
            let cls = i < state.pos ? "correct" : (i === state.pos ? "current" : "");
            h += `<span class="${cls}">${state.text[i]}</span>`;
        }
        d.innerHTML = h;
    }

    // –£–°–ò–õ–ï–ù–ù–ê–Ø –ó–ê–©–ò–¢–ê –û–¢ –ß–ò–¢–ï–†–°–¢–í–ê
    const typingInput = document.getElementById('typingInput');

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å—Ç–∞–≤–∫–∏
    typingInput.addEventListener('paste', e => {
        e.preventDefault();
        const inp = e.target;
        inp.classList.add('error');
        setTimeout(() => inp.classList.remove('error'), 300);
        showNotification('‚ùå –í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞!');
    });

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    typingInput.addEventListener('contextmenu', e => e.preventDefault());

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
    typingInput.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'v' || e.key === 'V')) {
            e.preventDefault();
            showNotification('‚ùå –í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞!');
        }
    });

    typingInput.addEventListener('input', e => {
        if (!state.isRacing) return;

        const inp = e.target;
        const val = inp.value;

        // –ê–ù–¢–ò-–ß–ò–¢: –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é –≤—Å—Ç–∞–≤–∫—É —Å–∏–º–≤–æ–ª–æ–≤
        const lengthDiff = val.length - state.lastInputLength;
        if (lengthDiff > 1 || e.inputType === 'insertFromPaste') {
            inp.value = "";
            state.lastInputLength = 0;
            inp.classList.add('error');
            setTimeout(() => inp.classList.remove('error'), 300);
            showNotification('‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ —á–∏—Ç–µ—Ä—Å—Ç–≤–∞!');
            return;
        }

        state.lastInputLength = val.length;
        const expectedNextChar = state.text[state.pos];

        if (val === expectedNextChar) {
            state.pos++;
            state.totalChars++;
            inp.value = "";
            state.lastInputLength = 0;
            inp.classList.remove('error');

            const elapsed = (Date.now() - state.startTime) / 60000;
            const wpm = Math.round((state.pos / 5) / elapsed) || 0;
            const acc = state.totalChars > 0 ? Math.round(((state.totalChars - state.errors) / state.totalChars) * 100) : 100;

            document.getElementById('wpm').innerText = wpm;
            document.getElementById('acc').innerText = acc + '%';
            document.getElementById('progress').innerText = Math.round((state.pos / state.text.length) * 100) + '%';

            const isFin = state.pos === state.text.length;

            if (!state.isSolo) {
                db.ref(`rooms/${state.roomID}/players/${state.playerName}`).update({
                    pos: state.pos, wpm: wpm, finished: isFin
                });
            } else {
                renderPlayers({[state.playerName]: {pos: state.pos, wpm: wpm, finished: isFin}});
            }

            if (isFin) {
                state.isRacing = false;
                clearInterval(state.timerInterval);
                inp.disabled = true;
                if (state.isSolo) {
                    setTimeout(() => {
                        showNotification(`üèÜ –§–∏–Ω–∏—à! ${wpm} WPM | –¢–æ—á–Ω–æ—Å—Ç—å: ${acc}%`);
                    }, 100);
                }
            }
        } else if (val.length > 0) {
            state.errors++;
            state.totalChars++;
            inp.classList.add('error');
            setTimeout(() => inp.classList.remove('error'), 200);
        }

        updateDisplayText();
    });
</script>
</body>
</html>