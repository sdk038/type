<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeRacer Pro Online</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        .container { max-width: 900px; width: 100%; }

        .game-info, .players-list, .text-display, .input-area, .stat-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        input {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px;
            border-radius: 8px;
            color: #333;
            outline: none;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        button:hover { opacity: 0.8; transform: translateY(-2px); }

        .race-track {
            height: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            position: relative;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        .race-car {
            position: absolute;
            transition: left 0.3s ease;
            font-size: 24px;
            top: -25px;
            margin-left: -12px;
        }

        .text-display { font-size: 22px; line-height: 1.6; text-align: center; }
        .correct { color: #4ade80; text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
        .current { border-bottom: 3px solid #fdbb2d; animation: blink 1s infinite; }

        @keyframes blink {
            50% { border-color: transparent; }
        }

        #countdown {
            font-size: 60px;
            text-align: center;
            color: #fdbb2d;
            font-weight: bold;
            height: 80px;
        }

        .stats-container { display: flex; justify-content: space-around; gap: 20px; }
        .stat-box { flex: 1; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #fdbb2d; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèéÔ∏è TypeRacer PRO Online</h1>

    <div class="game-info">
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="playerName" placeholder="–¢–≤–æ–µ –∏–º—è" style="flex: 1;">
            <input type="text" id="roomCode" placeholder="–ö–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞" style="flex: 1;">
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="createRoom()" style="background: #4ade80; flex: 1;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥–æ–Ω–∫—É</button>
            <button onclick="joinRoom()" style="background: #60a5fa; flex: 1;">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
        <div id="roomDisplay" style="margin-top: 15px; text-align: center; font-size: 18px; color: #fdbb2d;"></div>
    </div>

    <div id="playersList"></div>

    <div id="countdown"></div>

    <div class="text-display" id="textDisplay">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!</div>

    <div class="input-area">
        <input type="text" id="typingInput" style="width: 100%; font-size: 20px;" placeholder="–ñ–¥–∏—Ç–µ —Å—Ç–∞—Ä—Ç–∞..." disabled>
    </div>

    <div class="stats-container">
        <div class="stat-box">WPM: <br><span id="wpm" class="stat-value">0</span></div>
        <div class="stat-box">–ü—Ä–æ–≥—Ä–µ—Å—Å: <br><span id="progress" class="stat-value">0%</span></div>
    </div>
</div>

<script>
    // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–¢–≤–æ–∏ –∫–ª—é—á–∏)
    const firebaseConfig = {
        apiKey: "AIzaSyCX5cv94WSVGJfX9Vddgxrqgg9CEH_QgvA",
        authDomain: "prince-10014.firebaseapp.com",
        databaseURL: "https://prince-10014-default-rtdb.firebaseio.com",
        projectId: "prince-10014",
        storageBucket: "prince-10014.firebasestorage.app",
        messagingSenderId: "900737897462",
        appId: "1:900737897462:web:a29a4d2c8cada3a3f36dd7",
        measurementId: "G-EP6VX4V6ET"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let state = {
        roomID: null,
        playerName: '',
        text: '',
        pos: 0,
        startTime: null,
        isRacing: false
    };

    const texts = [
        "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ –Ω–µ —Ç–æ —á—Ç–æ —Ç—ã –∑–Ω–∞–µ—à—å, –∞ —Ç–æ —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –≤—ã—è—Å–Ω–∏—Ç—å.",
        "–°–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤—Å–µ–≥–¥–∞ –∏–º–µ—é—Ç –ø—Ä–æ—Å—Ç—ã–µ –∏ –ª–µ–≥–∫–∏–µ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.",
        "–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –±—É–¥—É—â–µ–µ —ç—Ç–æ –∏–∑–æ–±—Ä–µ—Å—Ç–∏ –µ–≥–æ —Å–∞–º–æ–º—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.",
        "–£—Å–ø–µ—Ö —ç—Ç–æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏–¥—Ç–∏ –æ—Ç –æ–¥–Ω–æ–π –Ω–µ—É–¥–∞—á–∏ –∫ –¥—Ä—É–≥–æ–π, –Ω–µ —Ç–µ—Ä—è—è —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞."
    ];

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
    async function createRoom() {
        const name = document.getElementById('playerName').value.trim();
        if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");

        const roomID = Math.random().toString(36).substring(2, 8).toUpperCase();
        const text = texts[Math.floor(Math.random() * texts.length)];

        state.roomID = roomID;
        state.playerName = name;
        state.text = text;

        await db.ref('rooms/' + roomID).set({
            text: text,
            status: 'waiting',
            players: { [name]: { pos: 0, wpm: 0, finished: false } }
        });

        listenToRoom(roomID);
    }

    // –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É
    async function joinRoom() {
        const roomID = document.getElementById('roomCode').value.trim().toUpperCase();
        const name = document.getElementById('playerName').value.trim();

        if (!roomID || !name) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã –∏ –∏–º—è!");

        const snapshot = await db.ref('rooms/' + roomID).once('value');
        if (!snapshot.exists()) return alert("–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");

        state.roomID = roomID;
        state.playerName = name;
        state.text = snapshot.val().text;

        await db.ref(`rooms/${roomID}/players/${name}`).set({
            pos: 0, wpm: 0, finished: false
        });

        listenToRoom(roomID);
    }

    // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    function listenToRoom(roomID) {
        document.getElementById('roomDisplay').innerText = "ID –ö–û–ú–ù–ê–¢–´: " + roomID;

        db.ref('rooms/' + roomID).on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            updatePlayersUI(data.players);

            // –ï—Å–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ 2+ –∏–≥—Ä–æ–∫–∞ –∏ –Ω–∏–∫—Ç–æ –µ—â–µ –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª - –∑–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å—á–µ—Ç
            if (Object.keys(data.players).length >= 2 && data.status === 'waiting') {
                startCountdown();
            }

            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω–∏–ª—Å—è –Ω–∞ racing - –Ω–∞—á–∏–Ω–∞–µ–º –≥–æ–Ω–∫—É
            if (data.status === 'racing' && !state.isRacing && state.startTime === null) {
                beginRace();
            }
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏ –º–∞—à–∏–Ω–æ–∫
    function updatePlayersUI(players) {
        const list = document.getElementById('playersList');
        list.innerHTML = '<h3 style="margin-bottom:10px;">üèéÔ∏è –£—á–∞—Å—Ç–Ω–∏–∫–∏:</h3>';

        for (let name in players) {
            const p = players[name];
            const perc = (p.pos / state.text.length) * 100;
            const isMe = name === state.playerName;

            list.innerHTML += `
                <div style="margin-bottom:20px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>${isMe ? '<b>(–í–´)</b> ' : ''}${name}</span>
                        <span>WPM: ${p.wpm} ${p.finished ? 'üö© –§–ò–ù–ò–®!' : ''}</span>
                    </div>
                    <div class="race-track">
                        <div class="race-car" style="left:${perc}%">üèéÔ∏è</div>
                    </div>
                </div>
            `;
        }
        updateTextDisplay();
    }

    // –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç—Å—á–µ—Ç
    function startCountdown() {
        db.ref(`rooms/${state.roomID}/status`).set('starting');
        let count = 3;
        const timer = setInterval(() => {
            document.getElementById('countdown').innerText = count > 0 ? count : '–ì–û–ù–ö–ê!';
            count--;
            if (count < -1) {
                clearInterval(timer);
                document.getElementById('countdown').innerText = '';
                db.ref(`rooms/${state.roomID}/status`).set('racing');
            }
        }, 1000);
    }

    // –ù–∞—á–∞–ª–æ –≥–æ–Ω–∫–∏ (—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–≤–æ–¥–∞)
    function beginRace() {
        state.isRacing = true;
        state.startTime = Date.now();
        const input = document.getElementById('typingInput');
        input.disabled = false;
        input.placeholder = "–ü–µ—á–∞—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å...";
        input.focus();
    }

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
    function updateTextDisplay() {
        const el = document.getElementById('textDisplay');
        let html = "";
        for (let i = 0; i < state.text.length; i++) {
            let cls = i < state.pos ? 'correct' : (i === state.pos ? 'current' : '');
            let char = state.text[i];
            html += `<span class="${cls}">${char}</span>`;
        }
        el.innerHTML = html;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞
    document.getElementById('typingInput').addEventListener('input', (e) => {
        if (!state.isRacing) return;

        const val = e.target.value;
        const lastChar = val[val.length - 1];
        const expectedChar = state.text[state.pos];

        if (lastChar === expectedChar) {
            state.pos++;
            e.target.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∏–º–≤–æ–ª–∞ (–∏–ª–∏ —Å–ª–æ–≤–∞)

            // –°—á–∏—Ç–∞–µ–º WPM (—Å–ª–æ–≤ –≤ –º–∏–Ω—É—Ç—É)
            const timePassed = (Date.now() - state.startTime) / 60000;
            const wpm = Math.round((state.pos / 5) / timePassed) || 0;
            const finished = state.pos === state.text.length;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ Firebase
            db.ref(`rooms/${state.roomID}/players/${state.playerName}`).update({
                pos: state.pos,
                wpm: wpm,
                finished: finished
            });

            if (finished) {
                state.isRacing = false;
                document.getElementById('typingInput').disabled = true;
                document.getElementById('typingInput').placeholder = "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —Ñ–∏–Ω–∏—à–∏—Ä–æ–≤–∞–ª–∏!";
            }

            document.getElementById('wpm').innerText = wpm;
            document.getElementById('progress').innerText = Math.round((state.pos / state.text.length) * 100) + '%';
        } else {
            e.target.value = '';
        }
    });
</script>

</body>
</html>