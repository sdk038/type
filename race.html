<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpeedRacer | Ultimate Type Experience</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #7000ff;
            --accent: #fdbb2d;
            --success: #22c55e;
            --bg: #050510;
            --card-bg: rgba(20, 20, 35, 0.95);
            --border: rgba(0, 242, 255, 0.2);
            --text-muted: #808090;
            --error: #ff4e50;
        }

        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        [data-theme="light"] {
            --primary: #0066cc;
            --secondary: #6b00cc;
            --accent: #ff9800;
            --bg: #f5f5f5;
            --card-bg: rgba(255, 255, 255, 0.95);
            --border: rgba(0, 0, 0, 0.1);
            --text-muted: #666;
            --error: #d32f2f;
            --success: #388e3c;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            outline: none;
        }
        
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            transition: background 0.3s ease;
        }

        [data-theme="light"] body {
            color: #333;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: radial-gradient(circle at 20% 50%, rgba(112, 0, 255, 0.15), transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(0, 242, 255, 0.15), transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(253, 187, 45, 0.1), transparent 50%);
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--primary);
            border-radius: 50%;
            animation: float 8s infinite ease-in-out;
            opacity: 0.3;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); }
            25% { transform: translateY(-100px) translateX(50px); }
            50% { transform: translateY(-200px) translateX(-50px); }
            75% { transform: translateY(-100px) translateX(100px); }
        }

        .container { 
            width: 100%; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 40px 20px;
            position: relative;
            z-index: 10;
        }

        .game-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 60px rgba(0, 242, 255, 0.1),
                        0 0 100px rgba(112, 0, 255, 0.05);
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 70px rgba(0, 242, 255, 0.15),
                        0 0 120px rgba(112, 0, 255, 0.08);
        }

        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            background-size: 200% 100%;
            animation: gradientFlow 3s ease infinite;
        }

        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .glow-text {
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: 3.5rem;
            text-align: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 4s ease infinite;
            text-shadow: 0 0 40px rgba(0, 242, 255, 0.5);
            margin-bottom: 20px;
        }

        .text-display {
            font-size: 1.8rem;
            line-height: 1.6;
            font-family: 'Inter', monospace;
            color: var(--text-muted);
            margin-bottom: 30px;
            letter-spacing: 0.3px;
            padding: 30px 0;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 10px;
        }

        .word {
            display: inline-flex;
            position: relative;
            padding: 6px 10px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .word.completed {
            color: var(--success);
        }

        .word.current {
            border: 2px solid var(--primary);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
            animation: pulse 1.5s infinite;
            transform: scale(1.05);
        }

        .word.error {
            color: var(--error);
            border: 2px solid var(--error);
            animation: shake 0.3s;
        }

        .word .char {
            display: inline-block;
            transition: all 0.15s ease;
        }

        .word.current .char.typed-correct {
            color: var(--success);
        }

        .word.current .char.typed-error {
            color: var(--error);
            background: rgba(255, 78, 80, 0.2);
            border-radius: 4px;
        }

        .cursor {
            position: absolute;
            width: 3px;
            height: 100%;
            background: var(--primary);
            animation: blink 1s infinite;
            left: 12px;
            top: 0;
            border-radius: 2px;
            box-shadow: 0 0 10px var(--primary);
        }

        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 25px var(--primary); }
            50% { opacity: 0.8; box-shadow: 0 0 40px var(--primary); }
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1.2) translateY(0); }
            50% { transform: scale(1.2) translateY(-3px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px) rotate(-2deg); }
            75% { transform: translateX(8px) rotate(2deg); }
        }

        #typingInput {
            width: 100%;
            padding: 25px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            font-family: 'Inter', monospace;
            text-align: center;
        }

        #typingInput:focus {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.3),
                        inset 0 0 20px rgba(0, 242, 255, 0.1);
            transform: scale(1.02);
        }

        #typingInput.error {
            border-color: var(--error);
            animation: shake 0.4s;
            box-shadow: 0 0 30px rgba(255, 78, 80, 0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.1), rgba(112, 0, 255, 0.1));
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--border);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.3);
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .stat-item:hover::before {
            left: 100%;
        }

        .stat-val {
            display: block;
            font-weight: 900;
            font-family: 'Orbitron', monospace;
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 8px;
            text-shadow: 0 0 20px var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        .track {
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            position: relative;
            margin: 50px 0 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .track::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 100%);
            animation: trackShine 2s linear infinite;
        }

        @keyframes trackShine {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        .car {
            position: absolute;
            top: -45px;
            font-size: 35px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 15px var(--primary)) 
                    drop-shadow(0 5px 10px rgba(0, 0, 0, 0.5));
            animation: carBounce 0.8s ease-in-out infinite;
        }

        @keyframes carBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .btn {
            padding: 18px 40px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s ease;
            font-size: 1rem;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff;
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--error));
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--accent));
            color: #000;
        }

        #countdown {
            font-size: 8rem;
            text-align: center;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: countdownPulse 1s ease-in-out infinite;
            text-shadow: 0 0 60px var(--primary);
        }

        @keyframes countdownPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        .lobby-input {
            width: 100%;
            padding: 18px 25px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.1rem;
            transition: all 0.3s;
            font-weight: 500;
        }

        .lobby-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
            transform: scale(1.02);
        }

        .share-link {
            background: rgba(0, 242, 255, 0.15);
            padding: 15px 25px;
            border-radius: 100px;
            border: 2px solid var(--primary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .share-link:hover {
            background: rgba(0, 242, 255, 0.25);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.4);
        }

        .copy-notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #000;
            padding: 20px 30px;
            border-radius: 16px;
            font-weight: 700;
            animation: slideIn 0.4s ease-out, fadeOut 0.4s 1.6s;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0, 242, 255, 0.5);
            font-size: 1.1rem;
        }

        @keyframes slideIn {
            from { transform: translateX(500px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-20px); }
        }

        .user-info {
            position: fixed;
            top: 25px;
            right: 25px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 2px solid var(--border);
            padding: 12px 25px;
            border-radius: 100px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 242, 255, 0.2);
        }

        .user-name {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.05rem;
        }

        .logout-btn, .admin-btn {
            background: rgba(255, 78, 80, 0.15);
            color: var(--error);
            border: 2px solid var(--error);
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 700;
            transition: all 0.3s;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .admin-btn {
            background: rgba(253, 187, 45, 0.15);
            color: var(--accent);
            border-color: var(--accent);
        }

        .logout-btn:hover {
            background: var(--error);
            color: #000;
            transform: scale(1.1);
        }

        .admin-btn:hover {
            background: var(--accent);
            color: #000;
            transform: scale(1.1);
        }

        .achievement {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            padding: 20px 30px;
            border-radius: 16px;
            color: #000;
            font-weight: 700;
            animation: achievementPop 0.5s ease-out;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(253, 187, 45, 0.6);
        }

        @keyframes achievementPop {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            70% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            border-radius: 10px;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px var(--primary);
        }

        .player-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .player-card:hover {
            transform: translateX(10px);
            border-color: var(--primary);
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.3);
        }

        .language-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .lang-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .lang-btn:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .lang-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: var(--primary);
            color: #fff;
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.4);
        }

        .restart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .restart-content {
            background: var(--card-bg);
            border: 2px solid var(--primary);
            border-radius: 24px;
            padding: 50px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 242, 255, 0.3);
        }

        .restart-timer {
            font-size: 5rem;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .glow-text { font-size: 2rem; }
            .text-display { font-size: 1.4rem; padding: 20px; gap: 8px; }
            #typingInput { font-size: 1.2rem; }
            .stat-val { font-size: 1.8rem; }
            #countdown { font-size: 5rem; }
            .restart-timer { font-size: 3rem; }
            .word { padding: 4px 8px; font-size: 1.2rem; }
        }

        .finish-celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary);
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>

<div class="bg-animation"></div>
<div class="particles" id="particles"></div>

<div class="user-info">
    <span class="user-name" id="userName">üë§ –ì–æ—Å—Ç—å</span>
    <a href="profile.html" class="admin-btn" style="background: rgba(0, 242, 255, 0.1); color: var(--primary); border: 1px solid var(--primary); display: inline-block;">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</a>
    <a href="panel.html" class="admin-btn" id="adminBtn" style="display: none;">üëë –ê–¥–º–∏–Ω</a>
    <button class="logout-btn" onclick="logout()">‚Üê –í—ã—Ö–æ–¥</button>
</div>

<div class="container">
    <div id="lobby" class="game-card" style="max-width: 550px; margin: 80px auto;">
        <h1 class="glow-text">üèéÔ∏è SPEEDRACER</h1>
        <p style="text-align: center; color: var(--text-muted); margin-bottom: 30px; font-size: 1.1rem;">
            –¢—Ä–µ–Ω–∏—Ä—É–π —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ –≤ —Å—Ç–∏–ª–µ –∫–∏–±–µ—Ä–ø–∞–Ω–∫!
        </p>

        <div class="language-selector">
            <button class="lang-btn active" onclick="selectLanguage('ru')" data-lang="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button class="lang-btn" onclick="selectLanguage('en')" data-lang="en">üá¨üáß English</button>
            <button class="lang-btn" onclick="selectLanguage('es')" data-lang="es">üá™üá∏ Espa√±ol</button>
            <button class="lang-btn" onclick="selectLanguage('fr')" data-lang="fr">üá´üá∑ Fran√ßais</button>
            <button class="lang-btn" onclick="selectLanguage('de')" data-lang="de">üá©üá™ Deutsch</button>
        </div>
        
        <input type="text" id="playerName" class="lobby-input" placeholder="üë§ –í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –∏–º—è" maxlength="20">
        <input type="text" id="roomCode" class="lobby-input" placeholder="üîê –ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" maxlength="6">

        <div style="display:grid; grid-template-columns: 1fr; gap:15px;">
            <button class="btn btn-primary" onclick="createRoom()">üåê –°–û–ó–î–ê–¢–¨ –û–ù–õ–ê–ô–ù –ì–û–ù–ö–£</button>
            <button class="btn btn-secondary" onclick="joinRoom()">üîó –í–û–ô–¢–ò –ü–û –ö–û–î–£</button>
            <button class="btn btn-success" onclick="startSolo()">‚ö° –û–î–ò–ù–û–ß–ù–ê–Ø –ü–†–ê–ö–¢–ò–ö–ê</button>
        </div>
    </div>

    <div id="gameView" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap: wrap; gap: 15px;">
            <div id="shareBox" class="share-link" onclick="copyLink()">
                <span id="roomInfo" style="font-weight: 800;">–ö–û–î: ...</span>
                <span>üìã –ö–û–ü–ò–†–û–í–ê–¢–¨</span>
            </div>
            <button class="btn" onclick="exitRoom()" style="background: rgba(255, 255, 255, 0.05); color: var(--text-muted); border: 2px solid var(--border); padding: 10px 20px; font-size: 0.9rem;">üè† –í –ª–æ–±–±–∏</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="globalProgress" style="width: 0%"></div>
        </div>

        <div id="countdown"></div>
        <div id="restartTimer" style="text-align: center; color: var(--accent); margin-bottom: 15px; font-size: 1.3rem; font-weight: 700;"></div>

        <button id="startBtn" class="btn btn-primary" style="display:none; width: 100%; margin-bottom: 30px; font-size: 1.2rem;" onclick="requestStart()">
            üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ –ì–û–ù–ö–£
        </button>

        <div class="game-card">
            <div id="textDisplay" class="text-display">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞—Å—Å—ã...</div>
            <input type="text" id="typingInput" placeholder="–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è –ø–µ—á–∞—Ç–∞—Ç—å..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled>

            <div class="stats-grid">
                <div class="stat-item">
                    <span id="wpm" class="stat-val">0</span>
                    <span class="stat-label">üí® WPM</span>
                </div>
                <div class="stat-item">
                    <span id="timer" class="stat-val">01:30</span>
                    <span class="stat-label">‚è±Ô∏è –û–°–¢–ê–õ–û–°–¨</span>
                </div>
                <div class="stat-item">
                    <span id="acc" class="stat-val">100%</span>
                    <span class="stat-label">üéØ –¢–û–ß–ù–û–°–¢–¨</span>
                </div>
                <div class="stat-item">
                    <span id="progress" class="stat-val">0%</span>
                    <span class="stat-label">üìä –ü–†–û–ì–†–ï–°–°</span>
                </div>
            </div>
        </div>
        
        <div id="playersList" style="margin-top: 30px;"></div>
    </div>
</div>

<div class="finish-celebration" id="celebration"></div>

<div class="restart-modal" id="restartModal">
    <div class="restart-content">
        <h2 style="font-size: 2.5rem; margin-bottom: 20px; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üèÅ –ì–æ–Ω–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
        </h2>
        <div id="finalStats" style="margin: 20px 0; color: var(--text-muted);"></div>
        <button class="btn btn-primary" onclick="manualRestart()" style="font-size: 1.3rem; padding: 20px 60px; margin-top: 20px;">
            üöÄ –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –≥–æ–Ω–∫—É
        </button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCX5cv94WSVGJfX9Vddgxrqgg9CEH_QgvA",
        authDomain: "prince-10014.firebaseapp.com",
        databaseURL: "https://prince-10014-default-rtdb.firebaseio.com",
        projectId: "prince-10014",
        storageBucket: "prince-10014.firebasestorage.app",
        messagingSenderId: "900737897462",
        appId: "1:900737897462:web:a29a4d2c8cada3a3f36dd7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã –¥–ª—è —Ñ–æ–Ω–∞
    function createParticles() {
        const particles = document.getElementById('particles');
        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 8 + 's';
            particle.style.animationDuration = (Math.random() * 10 + 5) + 's';
            particles.appendChild(particle);
        }
    }
    createParticles();

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 's' || e.key === 'i')) {
            e.preventDefault();
        }
        if (e.key === 'F12') {
            e.preventDefault();
        }
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const savedUser = localStorage.getItem('speedracer_user');
    if (!savedUser) {
        window.location.href = 'login.html';
    } else {
        const userData = JSON.parse(savedUser);
        document.getElementById('userName').textContent = 'üë§ ' + userData.username;
        document.getElementById('playerName').value = userData.username;
        
        if (userData.isAdmin) {
            document.getElementById('adminBtn').style.display = 'inline-block';
        }

        db.ref(`simple_users/${userData.userId}`).update({
            lastActivity: Date.now()
        });
    }

    function logout() {
        localStorage.removeItem('speedracer_user');
        window.location.href = 'login.html';
    }

    const wordsByLanguage = {
        ru: [
            // –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
            "–∫–∞–∫", "—ç—Ç–æ", "–≤—Å–µ", "–æ–Ω–∞", "—Ç–∞–∫", "–µ–≥–æ", "–Ω–æ", "–¥–∞", "—Ç—ã", "–º—ã", "–≤—ã", "–æ–Ω", "–æ–Ω–∏",
            "–±—ã—Ç—å", "–º–æ—á—å", "–Ω–∞—à", "–≤–µ—Å—å", "–≥–æ–¥", "–º–æ–π", "–∫–æ–≥–¥–∞", "–∫–æ—Ç–æ—Ä—ã–π", "–æ–¥–∏–Ω", "–¥–≤–∞", "–≥–¥–µ",
            "–∂–∏–∑–Ω—å", "–¥–µ–Ω—å", "—Ä—É–∫–∞", "—Ä–∞–∑", "–¥–µ–ª–æ", "–≤–∏–¥", "–≥–æ–ª–æ–≤–∞", "–¥–æ–º", "—Å–∏–ª–∞", "–ø–æ—Ä–∞", "—Å–ª–æ–≤–æ",
            "–º–µ—Å—Ç–æ", "–ª–∏—Ü–æ", "–¥—Ä—É–≥", "–≥–ª–∞–∑", "–≤–æ–ø—Ä–æ—Å", "–¥–æ—Ä–æ–≥–∞", "–≤–æ–π–Ω–∞", "–∫–æ–Ω–µ—Ü", "—Ñ–æ—Ä–º–∞", "—á–∞—Å—Ç—å",
            // –î–µ–π—Å—Ç–≤–∏—è
            "–¥–µ–ª–∞—Ç—å", "—Ö–æ—Ç–µ—Ç—å", "–∑–Ω–∞—Ç—å", "—Å—Ç–∞—Ç—å", "–µ—Å—Ç—å", "—Å–∏–¥–µ—Ç—å", "–∏–º–µ—Ç—å", "–≤–∏–¥–µ—Ç—å", "–∏–¥—Ç–∏", "–¥–∞—Ç—å",
            "–≥–æ–≤–æ—Ä–∏—Ç—å", "—Ä–∞–±–æ—Ç–∞—Ç—å", "—Å—Ç–æ—è—Ç—å", "–∂–∏—Ç—å", "–±—Ä–∞—Ç—å", "–ø–∏—Å–∞—Ç—å", "—Ö–æ–¥–∏—Ç—å", "–ª—é–±–∏—Ç—å", "–∏–≥—Ä–∞—Ç—å",
            "–¥—É–º–∞—Ç—å", "—á–∏—Ç–∞—Ç—å", "—Å–º–æ—Ç—Ä–µ—Ç—å", "—Å–ø–∞—Ç—å", "–ø–µ—Ç—å", "—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å", "—É—á–∏—Ç—å—Å—è", "–ø–æ–º–æ–≥–∞—Ç—å",
            // –û–ø–∏—Å–∞–Ω–∏—è
            "–±–æ–ª—å—à–æ–π", "–Ω–æ–≤—ã–π", "—Å—Ç–∞—Ä—ã–π", "—Ö–æ—Ä–æ—à–∏–π", "–ø–ª–æ—Ö–æ–π", "–º–æ–ª–æ–¥–æ–π", "–±–µ–ª—ã–π", "—á–µ—Ä–Ω—ã–π", "–∫—Ä–∞—Å–Ω—ã–π",
            "—Å–∏–Ω–∏–π", "–∑–µ–ª–µ–Ω—ã–π", "–∂–µ–ª—Ç—ã–π", "–±—ã—Å—Ç—Ä—ã–π", "–º–µ–¥–ª–µ–Ω–Ω—ã–π", "–≤—ã—Å–æ–∫–∏–π", "–Ω–∏–∑–∫–∏–π", "–¥–ª–∏–Ω–Ω—ã–π",
            // –ú–µ—Å—Ç–∞ –∏ –ø—Ä–µ–¥–º–µ—Ç—ã
            "–≥–æ—Ä–æ–¥", "—Å—Ç—Ä–∞–Ω–∞", "–º–∏—Ä", "–∑–µ–º–ª—è", "–≤–æ–¥–∞", "–Ω–µ–±–æ", "—Å–æ–ª–Ω—Ü–µ", "–ª—É–Ω–∞", "–∑–≤–µ–∑–¥–∞", "–¥–µ—Ä–µ–≤–æ",
            "–ª–µ—Å", "–ø–æ–ª–µ", "—Ä–µ–∫–∞", "–º–æ—Ä–µ", "–≥–æ—Ä–∞", "–¥–æ—Ä–æ–≥–∞", "–ø—É—Ç—å", "—à–∫–æ–ª–∞", "—Ä–∞–±–æ—Ç–∞", "–≤—Ä–µ–º—è",
            "—É—Ç—Ä–æ", "–≤–µ—á–µ—Ä", "–Ω–æ—á—å", "–∫–Ω–∏–≥–∞", "—Å—Ç–æ–ª", "–æ–∫–Ω–æ", "–¥–≤–µ—Ä—å", "–º–∞—à–∏–Ω–∞", "–∫–æ–º–ø—å—é—Ç–µ—Ä",
            // –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
            "–ø—Ä–æ–≥—Ä–∞–º–º–∞", "–∫–æ–¥", "–¥–∞–Ω–Ω—ã–µ", "—Ñ–∞–π–ª", "—Å–∏—Å—Ç–µ–º–∞", "—Å–µ—Ç—å", "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç", "—Å–∞–π—Ç", "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
            "—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞", "–ø—Ä–æ–µ–∫—Ç", "–∑–∞–¥–∞—á–∞", "—Ä–µ—à–µ–Ω–∏–µ", "–∞–ª–≥–æ—Ä–∏—Ç–º", "—Ñ—É–Ω–∫—Ü–∏—è", "–∫–ª–∞—Å—Å", "–º–µ—Ç–æ–¥",
            // –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è
            "–∏–¥–µ—è", "–º—ã—Å–ª—å", "—á—É–≤—Å—Ç–≤–æ", "–ª—é–±–æ–≤—å", "–Ω–∞–¥–µ–∂–¥–∞", "–≤–µ—Ä–∞", "–º–µ—á—Ç–∞", "—Ü–µ–ª—å", "—É—Å–ø–µ—Ö", "–ø–æ–±–µ–¥–∞",
            "—Å—á–∞—Å—Ç—å–µ", "—Ä–∞–¥–æ—Å—Ç—å", "–≥—Ä—É—Å—Ç—å", "—Å—Ç—Ä–∞—Ö", "—Å–∏–ª–∞", "—ç–Ω–µ—Ä–≥–∏—è", "–∑–Ω–∞–Ω–∏–µ", "–æ–ø—ã—Ç", "–∏—Å—Ç–æ—Ä–∏—è",
            "–±—É–¥—É—â–µ–µ", "–ø—Ä–æ—à–ª–æ–µ", "–Ω–∞—Å—Ç–æ—è—â–µ–µ", "–º–æ–º–µ–Ω—Ç", "—à–∞–Ω—Å", "–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å", "–≤—ã–±–æ—Ä", "—Å–≤–æ–±–æ–¥–∞"
        ],
        en: [
            // Common words
            "the", "be", "to", "of", "and", "in", "that", "have", "it", "for", "not", "on", "with",
            "he", "as", "you", "do", "at", "this", "but", "his", "by", "from", "they", "we", "say",
            "her", "she", "or", "an", "will", "my", "one", "all", "would", "there", "their", "what",
            // Actions
            "make", "know", "take", "see", "come", "think", "look", "want", "give", "use", "find",
            "tell", "ask", "work", "seem", "feel", "try", "leave", "call", "good", "new", "first",
            "last", "long", "great", "little", "own", "other", "old", "right", "big", "high", "small",
            "large", "next", "early", "young", "important", "few", "public", "bad", "same", "able",
            // Places and objects
            "time", "person", "year", "way", "day", "thing", "man", "world", "life", "hand", "part",
            "child", "eye", "woman", "place", "work", "week", "case", "point", "company", "number",
            "group", "problem", "fact", "water", "room", "money", "story", "book", "word", "area",
            // Technology
            "computer", "program", "code", "data", "file", "system", "network", "internet", "website",
            "application", "development", "project", "task", "solution", "algorithm", "function",
            "method", "class", "object", "array", "string", "variable", "loop", "condition",
            // Abstract concepts
            "idea", "thought", "feeling", "love", "hope", "dream", "goal", "success", "victory",
            "happiness", "joy", "fear", "power", "energy", "knowledge", "experience", "future",
            "past", "present", "moment", "chance", "opportunity", "choice", "freedom", "truth"
        ],
        es: [
            // Palabras comunes
            "el", "la", "de", "que", "y", "en", "un", "ser", "se", "no", "haber", "por", "con",
            "su", "para", "como", "estar", "tener", "le", "lo", "todo", "pero", "m√°s", "hacer",
            "o", "poder", "decir", "este", "ir", "otro", "ese", "si", "me", "ya", "ver", "dar",
            // Acciones
            "saber", "querer", "llegar", "pasar", "deber", "poner", "parecer", "quedar", "creer",
            "hablar", "llevar", "dejar", "seguir", "encontrar", "llamar", "venir", "pensar", "salir",
            "volver", "tomar", "conocer", "vivir", "sentir", "tratar", "mirar", "contar", "empezar",
            // Descripciones
            "grande", "bueno", "nuevo", "primero", "largo", "mucho", "mismo", "peque√±o", "otro",
            "√∫ltimo", "alto", "mismo", "joven", "viejo", "blanco", "negro", "rojo", "azul", "verde",
            // Lugares y objetos
            "tiempo", "a√±o", "d√≠a", "cosa", "hombre", "mundo", "vida", "mano", "parte", "ni√±o",
            "mujer", "lugar", "trabajo", "semana", "caso", "punto", "empresa", "n√∫mero", "grupo",
            "problema", "agua", "habitaci√≥n", "dinero", "historia", "libro", "palabra", "√°rea",
            // Tecnolog√≠a
            "ordenador", "programa", "c√≥digo", "datos", "archivo", "sistema", "red", "internet",
            "sitio", "aplicaci√≥n", "desarrollo", "proyecto", "tarea", "soluci√≥n", "algoritmo",
            "funci√≥n", "m√©todo", "clase", "objeto", "variable", "bucle", "condici√≥n",
            // Conceptos abstractos
            "idea", "pensamiento", "sentimiento", "amor", "esperanza", "sue√±o", "meta", "√©xito",
            "victoria", "felicidad", "alegr√≠a", "miedo", "poder", "energ√≠a", "conocimiento",
            "experiencia", "futuro", "pasado", "presente", "momento", "oportunidad", "libertad"
        ],
        fr: [
            // Mots communs
            "le", "de", "un", "√™tre", "et", "√†", "il", "avoir", "ne", "je", "son", "que", "se",
            "qui", "ce", "dans", "en", "du", "elle", "au", "pour", "pas", "que", "vous", "par",
            "sur", "faire", "plus", "dire", "me", "on", "mon", "lui", "nous", "comme", "mais",
            // Actions
            "aller", "voir", "pouvoir", "savoir", "vouloir", "venir", "falloir", "devoir", "croire",
            "trouver", "donner", "prendre", "parler", "aimer", "passer", "mettre", "demander",
            "tenir", "sembler", "laisser", "rester", "penser", "entrer", "sortir", "vivre",
            // Descriptions
            "grand", "petit", "bon", "nouveau", "jeune", "vieux", "beau", "blanc", "noir", "rouge",
            "bleu", "vert", "long", "court", "haut", "bas", "rapide", "lent", "fort", "faible",
            // Lieux et objets
            "temps", "ann√©e", "jour", "chose", "homme", "monde", "vie", "main", "partie", "enfant",
            "femme", "lieu", "travail", "semaine", "cas", "point", "entreprise", "nombre", "groupe",
            "probl√®me", "eau", "chambre", "argent", "histoire", "livre", "mot", "zone",
            // Technologie
            "ordinateur", "programme", "code", "donn√©es", "fichier", "syst√®me", "r√©seau", "internet",
            "site", "application", "d√©veloppement", "projet", "t√¢che", "solution", "algorithme",
            "fonction", "m√©thode", "classe", "objet", "variable", "boucle", "condition",
            // Concepts abstraits
            "id√©e", "pens√©e", "sentiment", "amour", "espoir", "r√™ve", "objectif", "succ√®s",
            "victoire", "bonheur", "joie", "peur", "pouvoir", "√©nergie", "connaissance",
            "exp√©rience", "futur", "pass√©", "pr√©sent", "moment", "chance", "libert√©", "v√©rit√©"
        ],
        de: [
            // H√§ufige W√∂rter
            "der", "die", "und", "in", "den", "von", "zu", "das", "mit", "sich", "des", "auf",
            "f√ºr", "ist", "im", "dem", "nicht", "ein", "eine", "als", "auch", "es", "an", "werden",
            "aus", "er", "hat", "dass", "sie", "nach", "wird", "bei", "einer", "um", "am", "sind",
            // Aktionen
            "sein", "haben", "werden", "k√∂nnen", "m√ºssen", "sagen", "geben", "kommen", "sollen",
            "wollen", "machen", "gehen", "wissen", "sehen", "lassen", "stehen", "finden", "bleiben",
            "liegen", "hei√üen", "denken", "nehmen", "tun", "d√ºrfen", "glauben", "halten", "nennen",
            // Beschreibungen
            "gro√ü", "klein", "gut", "neu", "jung", "alt", "sch√∂n", "wei√ü", "schwarz", "rot",
            "blau", "gr√ºn", "lang", "kurz", "hoch", "niedrig", "schnell", "langsam", "stark",
            // Orte und Objekte
            "Zeit", "Jahr", "Tag", "Sache", "Mann", "Welt", "Leben", "Hand", "Teil", "Kind",
            "Frau", "Ort", "Arbeit", "Woche", "Fall", "Punkt", "Firma", "Zahl", "Gruppe",
            "Problem", "Wasser", "Zimmer", "Geld", "Geschichte", "Buch", "Wort", "Bereich",
            // Technologie
            "Computer", "Programm", "Code", "Daten", "Datei", "System", "Netzwerk", "Internet",
            "Website", "Anwendung", "Entwicklung", "Projekt", "Aufgabe", "L√∂sung", "Algorithmus",
            "Funktion", "Methode", "Klasse", "Objekt", "Variable", "Schleife", "Bedingung",
            // Abstrakte Konzepte
            "Idee", "Gedanke", "Gef√ºhl", "Liebe", "Hoffnung", "Traum", "Ziel", "Erfolg",
            "Sieg", "Gl√ºck", "Freude", "Angst", "Kraft", "Energie", "Wissen", "Erfahrung",
            "Zukunft", "Vergangenheit", "Gegenwart", "Moment", "Chance", "Freiheit", "Wahrheit"
        ]
    };

    let selectedLanguage = 'ru';

    let state = {
        roomID: null, playerName: '', text: '',
        words: [], currentWordIndex: 0, currentWord: '',
        startTime: null, isRacing: false, isHost: false,
        timerInterval: null, restarting: false, isSolo: false,
        errors: 0, totalChars: 0, correctChars: 0,
        restartTimerInterval: null, raceTimeLimit: 90
    };

    function selectLanguage(lang) {
        selectedLanguage = lang;
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-lang="${lang}"]`).classList.add('active');
        showNotification(`üåç –Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω: ${document.querySelector(`[data-lang="${lang}"]`).textContent}`);
    }

    function getRandomPhrase() {
        const words = wordsByLanguage[selectedLanguage];
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ 30-50 —Å–ª–æ–≤
        const wordCount = Math.floor(Math.random() * 21) + 30; // –æ—Ç 30 –¥–æ 50
        const selectedWords = [];
        
        for (let i = 0; i < wordCount; i++) {
            const randomWord = words[Math.floor(Math.random() * words.length)];
            selectedWords.push(randomWord);
        }
        
        return selectedWords.join(' ');
    }

    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const rCode = urlParams.get('room');
        if (rCode) {
            document.getElementById('roomCode').value = rCode.toUpperCase();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã
        const savedTheme = localStorage.getItem('speedracer_theme') || 'dark';
        if (savedTheme === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —è–∑—ã–∫–∞
        const savedLang = localStorage.getItem('speedracer_language') || 'ru';
        if (savedLang && wordsByLanguage[savedLang]) {
            selectedLanguage = savedLang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const langBtn = document.querySelector(`[data-lang="${savedLang}"]`);
            if (langBtn) langBtn.classList.add('active');
        }
    };

    function showNotification(text) {
        const notif = document.createElement('div');
        notif.className = 'copy-notification';
        notif.textContent = text;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 2000);
    }

    function showAchievement(text) {
        const achievement = document.createElement('div');
        achievement.className = 'achievement';
        achievement.innerHTML = `üèÜ ${text}`;
        document.body.appendChild(achievement);
        setTimeout(() => achievement.remove(), 3000);
    }

    function createConfetti() {
        const celebration = document.getElementById('celebration');
        const colors = ['#00f2ff', '#7000ff', '#fdbb2d', '#22c55e', '#ff4e50'];
        
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.3 + 's';
                celebration.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }, i * 30);
        }
    }

    function copyLink() {
        const link = window.location.origin + window.location.pathname + "?room=" + state.roomID;
        navigator.clipboard.writeText(link).then(() => {
            showNotification('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        });
    }

    function initView() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameView').style.display = 'block';
        document.getElementById('roomInfo').innerText = "–ö–û–î: " + state.roomID;
        if (state.isHost || state.isSolo) document.getElementById('startBtn').style.display = 'block';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å—Ä–∞–∑—É
        if (state.text) {
            state.words = state.text.split(' ');
            state.currentWordIndex = 0;
            displayInitialText();
        }

        const newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + state.roomID;
        window.history.pushState({path:newurl},'',newurl);
    }

    function displayInitialText() {
        const d = document.getElementById('textDisplay');
        let h = "";
        
        state.words.forEach((word, index) => {
            h += `<span class="word">${word.split('').map(char => `<span class="char">${char}</span>`).join('')}</span>`;
        });
        
        d.innerHTML = h;
    }

    async function createRoom() {
        const n = document.getElementById('playerName').value.trim() || "–ì–æ–Ω—â–∏–∫";
        const r = Math.random().toString(36).substring(2, 6).toUpperCase();
        state = {...state, roomID: r, playerName: n, isHost: true, isSolo: false};
        await db.ref('rooms/' + r).set({
            text: getRandomPhrase(),
            language: selectedLanguage,
            status: 'waiting', players: {[n]: {wordIndex: 0, wpm: 0, finished: false}}
        });
        initView();
        listen(r);
        showNotification('üéÆ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! –ü–æ–¥–µ–ª–∏—Å—å –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏!');
    }

    async function startSolo() {
        const n = document.getElementById('playerName').value.trim() || "–°–æ–ª–æ";
        const r = "SOLO-" + Math.random().toString(36).substring(2, 5).toUpperCase();
        state = {...state, roomID: r, playerName: n, isHost: true, isSolo: true};
        state.text = getRandomPhrase();
        initView();
        document.getElementById('shareBox').style.display = 'none';
        renderPlayers({[n]: {wordIndex: 0, wpm: 0, finished: false}});
        showNotification('‚ö° –û–¥–∏–Ω–æ—á–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!');
    }

    async function joinRoom() {
        const r = document.getElementById('roomCode').value.trim().toUpperCase();
        const n = document.getElementById('playerName').value.trim() || "–£—á–∞—Å—Ç–Ω–∏–∫";
        if (!r) {
            showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!');
            return;
        }
        const snap = await db.ref(`rooms/${r}`).once('value');
        if (!snap.exists()) {
            showNotification('‚ùå –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            return;
        }
        state = {...state, roomID: r, playerName: n, isHost: false, isSolo: false};
        await db.ref(`rooms/${r}/players/${n}`).update({wordIndex: 0, wpm: 0, finished: false});
        initView();
        listen(r);
        showNotification('‚úì –í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –≥–æ–Ω–∫–µ!');
    }

    function exitRoom() {
        if (state.roomID && !state.isSolo) {
            db.ref(`rooms/${state.roomID}/players/${state.playerName}`).remove();
        }
        window.location.href = window.location.pathname;
    }

    function listen(r) {
        if (state.isSolo) return;
        db.ref('rooms/' + r).on('value', snap => {
            const d = snap.val();
            if (!d) return;
            state.text = d.text;
            if (d.language) selectedLanguage = d.language;
            renderPlayers(d.players);
            if (d.status === 'starting' && !state.counting) startCountdown();
            if (d.status === 'racing' && !state.isRacing) startRace();

            const pArray = Object.values(d.players);
            if (pArray.every(p => p.finished) && d.status === 'racing' && !state.restarting) {
                startAutoRestart();
            }
        });
    }

    function requestStart() {
        if (state.isSolo) startCountdown();
        else db.ref(`rooms/${state.roomID}/status`).set('starting');
    }

    function startCountdown() {
        state.counting = true;
        document.getElementById('startBtn').style.display = 'none';
        let c = 3;
        const countdownEl = document.getElementById('countdown');
        
        const t = setInterval(() => {
            countdownEl.innerText = c > 0 ? c : 'üöÄ –ì–û!';
            if (c === 0) {
                showNotification('üèÅ –°–¢–ê–†–¢!');
            }
            c--;
            if (c < -1) {
                clearInterval(t);
                countdownEl.innerText = '';
                if (state.isSolo) startRace();
                else if (state.isHost) db.ref(`rooms/${state.roomID}/status`).set('racing');
                state.counting = false;
            }
        }, 1000);
    }

    function startRace() {
        state.isRacing = true;
        state.restarting = false;
        state.startTime = Date.now();
        state.currentWordIndex = 0;
        state.errors = 0;
        state.totalChars = 0;
        state.correctChars = 0;
        state.words = state.text.split(' ');

        const inp = document.getElementById('typingInput');
        inp.disabled = false;
        inp.value = "";
        inp.classList.remove('error');
        inp.placeholder = "–ü–µ—á–∞—Ç–∞–π —Å–ª–æ–≤–∞ –∏ –Ω–∞–∂–∏–º–∞–π –ü–†–û–ë–ï–õ...";
        inp.focus();

        updateDisplayText();

        // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
        state.timeLeft = state.raceTimeLimit;
        
        state.timerInterval = setInterval(() => {
            state.timeLeft--;
            const minutes = Math.floor(state.timeLeft / 60);
            const seconds = state.timeLeft % 60;
            document.getElementById('timer').innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // –ö–æ–≥–¥–∞ –≤—Ä–µ–º—è –≤—ã—à–ª–æ
            if (state.timeLeft <= 0) {
                clearInterval(state.timerInterval);
                if (state.isRacing) {
                    state.isRacing = false;
                    const inp = document.getElementById('typingInput');
                    inp.disabled = true;
                    showNotification('‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ!');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    if (state.isSolo || Object.values(state.players || {}).every(p => p.finished)) {
                        startAutoRestart();
                    }
                }
            }
        }, 1000);
    }

    function startAutoRestart() {
        state.restarting = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        const modal = document.getElementById('restartModal');
        modal.style.display = 'flex';
        
        const elapsed = (Date.now() - state.startTime) / 1000;
        const wpm = Math.round((state.currentWordIndex / (elapsed / 60))) || 0;
        const acc = state.totalChars > 0 ? Math.round((state.correctChars / state.totalChars) * 100) : 100;
        
        document.getElementById('finalStats').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div style="padding: 15px; background: rgba(0, 242, 255, 0.1); border-radius: 12px;">
                    <div style="font-size: 2rem; color: var(--primary); font-weight: 800;">${wpm}</div>
                    <div style="font-size: 0.9rem;">WPM</div>
                </div>
                <div style="padding: 15px; background: rgba(34, 197, 94, 0.1); border-radius: 12px;">
                    <div style="font-size: 2rem; color: var(--success); font-weight: 800;">${acc}%</div>
                    <div style="font-size: 0.9rem;">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                </div>
            </div>
        `;
        
        // –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∞–π–º–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
        if (state.restartTimerInterval) {
            clearInterval(state.restartTimerInterval);
        }
    }

    function manualRestart() {
        if (state.restartTimerInterval) {
            clearInterval(state.restartTimerInterval);
        }
        
        document.getElementById('restartModal').style.display = 'none';
        document.getElementById('restartTimer').innerText = '';
        
        if (state.isSolo) {
            state.text = getRandomPhrase();
            renderPlayers({[state.playerName]: {wordIndex: 0, wpm: 0, finished: false}});
            startCountdown();
        } else if (state.isHost) {
            db.ref(`rooms/${state.roomID}`).update({
                status: 'starting',
                text: getRandomPhrase(),
                language: selectedLanguage
            });
                    db.ref(`rooms/${state.roomID}/players`).once('value', s => {
                        const players = s.val();
                        for (let p in players) {
                            db.ref(`rooms/${state.roomID}/players/${p}`).update({wordIndex: 0, wpm: 0, finished: false});
                        }
                    });
        }
    }

    function renderPlayers(players) {
        const list = document.getElementById('playersList');
        list.innerHTML = '';
        for (let n in players) {
            const p = players[n];
            const perc = state.words.length > 0 ? (p.wordIndex / state.words.length) * 100 : 0;
            const statusEmoji = p.finished ? 'üèÅ' : 'üèéÔ∏è';
            const isYou = n === state.playerName;
            
            list.innerHTML += `
                <div class="player-card" style="${isYou ? 'border-color: var(--primary); box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);' : ''}">
                    <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom: 12px;">
                        <span style="font-weight: 700; color: ${isYou ? 'var(--primary)' : '#fff'};">
                            ${n} ${isYou ? '(–í–´)' : ''}
                        </span>
                        <span style="color: var(--accent); font-weight: 700; font-size: 16px;">${p.wpm} WPM</span>
                    </div>
                    <div class="track">
                        <div class="car" style="left:${perc}%">${statusEmoji}</div>
                    </div>
                </div>`;
        }
        updateDisplayText();
    }

    function updateDisplayText() {
        const d = document.getElementById('textDisplay');
        const inp = document.getElementById('typingInput');
        const currentInput = inp.value;
        
        let h = "";
        
        state.words.forEach((word, index) => {
            let wordClass = '';
            let wordContent = '';
            
            if (index < state.currentWordIndex) {
                // –ó–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ
                wordClass = 'completed';
                wordContent = word.split('').map(char => `<span class="char">${char}</span>`).join('');
            } else if (index === state.currentWordIndex) {
                // –¢–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ
                wordClass = 'current';
                const chars = word.split('');
                
                wordContent = chars.map((char, i) => {
                    let charClass = '';
                    if (i < currentInput.length) {
                        charClass = currentInput[i] === char ? 'typed-correct' : 'typed-error';
                    }
                    return `<span class="char ${charClass}">${char}</span>`;
                }).join('');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä
                wordContent = `<div class="cursor" style="left: ${10 + currentInput.length * 14}px;"></div>` + wordContent;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏
                if (currentInput.length > 0 && currentInput !== word.substring(0, currentInput.length)) {
                    wordClass += ' error';
                }
            } else {
                // –ë—É–¥—É—â–µ–µ —Å–ª–æ–≤–æ
                wordContent = word.split('').map(char => `<span class="char">${char}</span>`).join('');
            }
            
            h += `<div class="word ${wordClass}">${wordContent}</div>`;
        });
        
        d.innerHTML = h;

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        const globalProgress = state.words.length > 0 ? (state.currentWordIndex / state.words.length) * 100 : 0;
        document.getElementById('globalProgress').style.width = globalProgress + '%';
    }

    const typingInput = document.getElementById('typingInput');

    typingInput.addEventListener('paste', e => {
        e.preventDefault();
        typingInput.classList.add('error');
        setTimeout(() => typingInput.classList.remove('error'), 300);
        showNotification('‚ùå –í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞! –ü–µ—á–∞—Ç–∞–π —Å–∞–º!');
    });

    typingInput.addEventListener('contextmenu', e => e.preventDefault());

    typingInput.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'v' || e.key === 'V')) {
            e.preventDefault();
            showNotification('‚ùå –í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞!');
        }
    });

    typingInput.addEventListener('input', e => {
        if (!state.isRacing) return;
        updateDisplayText();
    });

    typingInput.addEventListener('keydown', e => {
        if (!state.isRacing) return;
        
        const inp = e.target;
        const val = inp.value.trim();
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–±–µ–ª–∞
        if (e.key === ' ' || e.code === 'Space') {
            e.preventDefault();
            
            if (!val) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å–ª–æ–≤–∞
            
            const currentWord = state.words[state.currentWordIndex];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ–≤–æ
            if (val === currentWord) {
                // –ü—Ä–∞–≤–∏–ª—å–Ω–æ!
                state.correctChars += currentWord.length + 1; // +1 –∑–∞ –ø—Ä–æ–±–µ–ª
                state.totalChars += currentWord.length + 1;
            } else {
                // –û—à–∏–±–∫–∞
                state.errors += Math.abs(currentWord.length - val.length);
                state.totalChars += Math.max(currentWord.length, val.length) + 1;
                
                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
                for (let i = 0; i < Math.min(val.length, currentWord.length); i++) {
                    if (val[i] === currentWord[i]) {
                        state.correctChars++;
                    }
                }
            }
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ª–æ–≤—É
            state.currentWordIndex++;
            inp.value = "";
            inp.classList.remove('error');
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const elapsed = (Date.now() - state.startTime) / 60000;
            const wordsTyped = state.currentWordIndex;
            const wpm = Math.round(wordsTyped / elapsed) || 0;
            const acc = state.totalChars > 0 ? Math.round((state.correctChars / state.totalChars) * 100) : 100;

            document.getElementById('wpm').innerText = wpm;
            document.getElementById('acc').innerText = acc + '%';
            document.getElementById('progress').innerText = Math.round((state.currentWordIndex / state.words.length) * 100) + '%';

            // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            if (wpm >= 100 && !state.achievement100) {
                showAchievement('–°–∫–æ—Ä–æ—Å—Ç—å 100+ WPM!');
                state.achievement100 = true;
            }
            if (acc === 100 && state.currentWordIndex > 10 && !state.achievementPerfect) {
                showAchievement('–ò–¥–µ–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å!');
                state.achievementPerfect = true;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            const isFin = state.currentWordIndex >= state.words.length;

            if (!state.isSolo) {
                db.ref(`rooms/${state.roomID}/players/${state.playerName}`).update({
                    wordIndex: state.currentWordIndex,
                    wpm: wpm,
                    finished: isFin
                });
            } else {
                renderPlayers({[state.playerName]: {
                    wordIndex: state.currentWordIndex,
                    wpm: wpm,
                    finished: isFin
                }});
            }

            if (isFin) {
                state.isRacing = false;
                clearInterval(state.timerInterval);
                inp.disabled = true;
                createConfetti();
                showNotification(`üèÜ –§–ò–ù–ò–®! ${wpm} WPM | –¢–æ—á–Ω–æ—Å—Ç—å: ${acc}%`);
                if (wpm > 80) {
                    showAchievement('–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!');
                }
            }
            
            updateDisplayText();
        }
    });
</script>
</body>
</html>
