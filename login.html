<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeedRacer | –í—Ö–æ–¥</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #7000ff;
            --bg: #050510;
            --card-bg: rgba(20, 20, 35, 0.95);
            --border: rgba(0, 242, 255, 0.3);
            --text-muted: #808090;
            --error: #ff4e50;
            --success: #22c55e;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            outline: none;
        }
        
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: radial-gradient(circle at top right, #1a1a3a, #050510);
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
        }

        .auth-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 2px solid var(--border);
            border-radius: 24px;
            padding: 50px 40px;
            box-shadow: 0 25px 60px rgba(0, 242, 255, 0.15);
            position: relative;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            animation: gradientFlow 3s ease infinite;
            background-size: 200% 100%;
        }

        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .logo {
            text-align: center;
            font-size: 4rem;
            margin-bottom: 15px;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .title {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Orbitron', monospace;
        }

        .subtitle {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 40px;
            font-size: 1rem;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            margin-bottom: 10px;
            color: var(--primary);
            font-size: 0.9rem;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .input-field {
            width: 100%;
            padding: 18px 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: #fff;
            font-size: 1.1rem;
            transition: all 0.3s;
            font-weight: 500;
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 25px rgba(0, 242, 255, 0.3);
            transform: scale(1.02);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        .btn {
            width: 100%;
            padding: 20px;
            border-radius: 14px;
            border: none;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 1.1rem;
            letter-spacing: 2px;
            transition: all 0.3s;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff;
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 400px;
            height: 400px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 242, 255, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            display: none;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .message.error {
            background: rgba(255, 78, 80, 0.15);
            border: 2px solid var(--error);
            color: var(--error);
            display: block;
        }

        .message.success {
            background: rgba(34, 197, 94, 0.15);
            border: 2px solid var(--success);
            color: var(--success);
            display: block;
        }

        .message.info {
            background: rgba(0, 242, 255, 0.15);
            border: 2px solid var(--primary);
            color: var(--primary);
            display: block;
        }

        .hint {
            text-align: center;
            margin-top: 25px;
            color: var(--text-muted);
            font-size: 0.9rem;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        .feature {
            text-align: center;
            padding: 15px;
            background: rgba(0, 242, 255, 0.05);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .feature:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.2);
        }

        .feature-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .feature-text {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
            display: none;
        }

        .connection-status.connected {
            display: block;
        }
    </style>
</head>
<body>

<div class="connection-status" id="connectionStatus">
    ‚ö° –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É
</div>

<div class="container">
    <div class="auth-card">
        <div class="logo">üèéÔ∏è</div>
        <h1 class="title">SPEEDRACER</h1>
        <p class="subtitle">–í–æ–π—Ç–∏ –≤ –≥–æ–Ω–∫—É –∑–∞ —Å–µ–∫—É–Ω–¥—ã</p>

        <div id="message" class="message"></div>

        <div id="loginForm">
            <div class="input-group">
                <label class="input-label">üë§ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input 
                    type="text" 
                    id="username" 
                    class="input-field" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" 
                    maxlength="20" 
                    autocomplete="username"
                    autofocus
                >
            </div>
            <div class="input-group">
                <label class="input-label">üîê –ü–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input 
                    type="password" 
                    id="password" 
                    class="input-field" 
                    placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞" 
                    autocomplete="current-password"
                >
            </div>
            <button id="loginBtn" class="btn">üöÄ –í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</button>
        </div>

        <div class="hint">
            üí° <strong>–°–æ–≤–µ—Ç:</strong> –ú–æ–∂–µ—Ç–µ –Ω–µ –≤–≤–æ–¥–∏—Ç—å –ø–∞—Ä–æ–ª—å!<br>
            –ü—Ä–æ—Å—Ç–æ —É–∫–∞–∂–∏—Ç–µ –∏–º—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏"
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">‚ö°</div>
                <div class="feature-text">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥</div>
            </div>
            <div class="feature">
                <div class="feature-icon">üîí</div>
                <div class="feature-text">–ë–µ–∑–æ–ø–∞—Å–Ω–æ</div>
            </div>
            <div class="feature">
                <div class="feature-icon">üåç</div>
                <div class="feature-text">5 —è–∑—ã–∫–æ–≤</div>
            </div>
            <div class="feature">
                <div class="feature-icon">üèÜ</div>
                <div class="feature-text">–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è</div>
            </div>
        </div>
    </div>
</div>

<script>
    // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const firebaseConfig = {
        apiKey: "AIzaSyCX5cv94WSVGJfX9Vddgxrqgg9CEH_QgvA",
        authDomain: "prince-10014.firebaseapp.com",
        databaseURL: "https://prince-10014-default-rtdb.firebaseio.com",
        projectId: "prince-10014",
        storageBucket: "prince-10014.firebasestorage.app",
        messagingSenderId: "900737897462",
        appId: "1:900737897462:web:a29a4d2c8cada3a3f36dd7"
    };

    let db;
    let isFirebaseReady = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        db.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                isFirebaseReady = true;
                document.getElementById('connectionStatus').classList.add('connected');
                console.log('‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω');
            } else {
                isFirebaseReady = false;
                showMessage('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ä–≤–µ—Ä—É...', 'error');
            }
        });
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
        showMessage('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
    }

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const message = document.getElementById('message');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–µ—Å—Å–∏–∏
    const savedUser = localStorage.getItem('speedracer_user');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            showMessage(`üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${userData.username}!`, 'info');
            setTimeout(() => {
                window.location.href = 'game.html';
            }, 800);
        } catch (e) {
            localStorage.removeItem('speedracer_user');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞
    async function handleLogin() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value;

        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!username) {
            showMessage('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
            usernameInput.focus();
            return;
        }

        if (username.length < 2) {
            showMessage('‚ùå –ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞', 'error');
            usernameInput.focus();
            return;
        }

        if (username.length > 20) {
            showMessage('‚ùå –ò–º—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤)', 'error');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã (—Ä–∞–∑—Ä–µ—à–µ–Ω—ã –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, —Ç–æ—á–∫–∏, —Ç–∏—Ä–µ, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è)
        if (!/^[a-zA-Z–∞-—è–ê-–Ø0-9._\-\s]+$/.test(username)) {
            showMessage('‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, —Ç–æ—á–∫–∏ –∏ —Ç–∏—Ä–µ', 'error');
            return;
        }

        if (!isFirebaseReady) {
            showMessage('‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã', 'error');
            return;
        }

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        loginBtn.disabled = true;
        loginBtn.innerHTML = '‚è≥ –í—Ö–æ–¥–∏–º... <span class="spinner"></span>';
        showMessage('üîÑ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É...', 'info');

        try {
            console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –≤—Ö–æ–¥ –¥–ª—è:', username);

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
            const userId = username.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            if (!userId) {
                throw new Error('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userSnapshot = await db.ref(`simple_users/${userId}`).once('value');
            const existingUser = userSnapshot.val();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
            if (existingUser && existingUser.password) {
                if (!password) {
                    showMessage('üîê –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—â–∏—â—ë–Ω –ø–∞—Ä–æ–ª–µ–º. –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å.', 'error');
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = 'üöÄ –í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É';
                    passwordInput.focus();
                    return;
                }
                
                if (password !== existingUser.password) {
                    showMessage('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = 'üöÄ –í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É';
                    passwordInput.focus();
                    return;
                }
            }

            // –ü–æ–ª—É—á–∞–µ–º IP
            let userIP = 'unknown';
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json', {
                    timeout: 3000
                });
                const ipData = await ipResponse.json();
                userIP = ipData.ip;
            } catch (e) {
                console.log('‚ÑπÔ∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ');
            }

            // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userData = {
                username: username,
                userId: userId,
                password: password || null,
                lastLogin: Date.now(),
                lastActivity: Date.now(),
                isAdmin: existingUser?.isAdmin || false,
                createdAt: existingUser?.createdAt || Date.now()
            };

            console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
            await db.ref(`simple_users/${userId}`).set(userData);

            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Ö–æ–¥ –≤ –∏—Å—Ç–æ—Ä–∏—é
            await db.ref(`simple_users/${userId}/logins`).push({
                timestamp: Date.now(),
                ip: userIP,
                userAgent: navigator.userAgent
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('speedracer_user', JSON.stringify(userData));

            console.log('‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!');
            showMessage('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...', 'success');

            setTimeout(() => {
                window.location.href = 'game.html';
            }, 1200);

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
            
            let errorMsg = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. ';
            if (error.code === 'PERMISSION_DENIED') {
                errorMsg += '–ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.';
            } else if (error.message.includes('network')) {
                errorMsg += '–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.';
            } else {
                errorMsg += error.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
            }
            
            showMessage('‚ùå ' + errorMsg, 'error');
            loginBtn.disabled = false;
            loginBtn.innerHTML = 'üöÄ –í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É';
        }
    }

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
    loginBtn.addEventListener('click', handleLogin);

    // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            if (!usernameInput.value.trim()) return;
            if (passwordInput.value || !document.activeElement || document.activeElement === usernameInput) {
                handleLogin();
            } else {
                passwordInput.focus();
            }
        }
    });

    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleLogin();
        }
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    function showMessage(text, type) {
        message.textContent = text;
        message.className = 'message ' + type;
        
        // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ –¥–ª—è info —Å–æ–æ–±—â–µ–Ω–∏–π
        if (type === 'info') {
            setTimeout(() => {
                message.className = 'message';
            }, 3000);
        }
    }

    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
    setTimeout(() => {
        usernameInput.focus();
    }, 300);
</script>

</body>
</html>
